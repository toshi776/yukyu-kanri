# テスト実行ガイド

## テスト実行手順（GASエディタ）

### 1. GASエディタを開く

```bash
clasp open
```

または、以下のURLから直接アクセス：
- Script ID: `1JBx6pQKBVB68Ud2pbQf6n2YmLYHeSWuM_2vV2hD9zfGdI6BC1MQJOY-6`
- URL: https://script.google.com/d/1JBx6pQKBVB68Ud2pbQf6n2YmLYHeSWuM_2vV2hD9zfGdI6BC1MQJOY-6/edit

### 2. テスト関数を選択して実行

GASエディタの上部メニューから：
1. 関数選択ドロップダウンをクリック
2. 実行したいテスト関数を選択
3. 実行ボタン（▶）をクリック
4. ログを確認（表示 → ログ または Ctrl+Enter）

---

## 実行するテスト

### テスト1: エッジケース・境界値テスト

**関数名:** `runEdgeCaseTests`

**テスト内容:**
1. 残日数境界値テスト
   - 残日数0日での申請拒否確認
   - 残日数超過申請の拒否確認
   - 残日数ピッタリの申請許可確認
   - マイナス日数申請の拒否確認
   - 小数点日数（0.5日）の処理確認

2. 無効データテスト
   - 存在しない利用者IDでの処理
   - 空文字列・null・undefinedの処理
   - 不正なURLキーでのアクセス拒否
   - 極端に長い文字列の処理

3. 日付境界値テスト
   - うるう年の日数計算
   - 年末年始の日付処理
   - 失効日当日の処理
   - 過去/未来日付での付与

4. 複雑なFIFO消費テスト
   - 最も古い付与から消費されるか
   - 複数付与に跨がる消費
   - 同一失効日の複数付与の消費順序

5. 失効日境界テスト
   - 失効日前日の残日数確認
   - 失効日翌日の残日数確認（0日になるか）
   - 失効処理の実行

6. 重複申請検出テスト
   - 同一日に複数申請の検出
   - 重複期間の申請検出

7. URLキーセキュリティテスト
   - URLキーの一意性確認
   - URLキーの長さ確認（32文字）
   - URLキーの文字種確認（英数字のみ）
   - 短いキー・特殊文字キーでのアクセス拒否

**期待される結果:**
- 全7種類のテストが成功
- 異常系が適切に拒否される
- 境界値が正しく処理される

**実行時間:** 約30秒〜1分

---

### テスト2: データ整合性詳細確認テスト

**関数名:** `runDataIntegrityTests`

**テスト内容:**
1. マスターシートと付与履歴の整合性
   - 全マスターユーザーに付与履歴が存在するか
   - 付与履歴のユーザーが全てマスターに存在するか
   - 残日数が0以上か

2. 計算残日数と実残日数の一致
   - ユーザーごとの計算結果と合計の一致確認
   - 小数点誤差（0.01日以内）の許容

3. 申請日数と消費日数の整合性
   - 承認済み申請の合計日数
   - 付与履歴から計算した消費日数
   - 両者の一致確認（手動消費等を考慮）

4. 付与日数の法定ルール準拠
   - 初回付与: 1-15日の範囲内か
   - 年次付与: 10-20日の範囲内か

5. 失効日の正確性
   - 失効日が付与日から2年後の前日か

6. URL管理とマスターの同期
   - 全マスターユーザーにURLが存在するか
   - URLユーザーが全てマスターに存在するか

**期待される結果:**
- 全6種類のテストが成功または警告
- データの内部整合性が保たれている
- 法定ルールに準拠している

**実行時間:** 約1〜2分

---

### テスト3: システム統合テスト

**関数名:** `runSystemIntegrationTests`

**テスト内容:**
1. 基盤システム統合テスト
   - URL管理システム
   - アクセス制御システム
   - データベース接続
   - マスターデータ構造

2. 法定付与システム統合テスト
   - 付与ルール計算システム
   - 付与履歴管理システム
   - FIFO消費システム
   - 失効処理システム

3. 通知システム統合テスト
   - 通知設定管理
   - メールテンプレート生成
   - 通知送信システム
   - 一括通知システム

4. 統計レポートシステム統合テスト
   - 基本統計計算
   - 月次レポート生成
   - HTMLレポート生成
   - 年5日取得義務監視

5. データ整合性システムテスト
   - データ整合性チェック
   - シート構造整合性
   - 計算ロジック整合性

6. システムパフォーマンステスト
   - レポート生成時間（10秒以内）
   - 統計計算時間（5秒以内）
   - データアクセス時間（3秒以内）

7. システムセキュリティテスト
   - URLキー生成セキュリティ
   - データアクセス制御
   - PropertiesService保護

**期待される結果:**
- 全7種類のテストが成功
- システム全体が正常に動作
- パフォーマンス目標を達成

**実行時間:** 約2〜3分

---

### テスト4: 全テスト統合実行（オプション）

**関数名:** `runAllTests`

**テスト内容:**
- 上記3つのテストを含む全11種類のテストを一括実行
- URL管理、付与ルール計算、付与履歴管理、FIFO消費、失効処理、通知システム、年次付与、トリガー管理、統計レポート、エッジケース、データ整合性

**期待される結果:**
- 全11種類のテストが成功
- 総合的なシステム品質の確認

**実行時間:** 約5〜10分

---

## ログの確認方法

### 実行ログの表示

1. GASエディタで「表示」→「ログ」を選択
2. または `Ctrl+Enter`（Windows/Linux）、`Cmd+Enter`（Mac）

### ログの見方

```
=== エッジケース・境界値テスト開始 ===

1. 残日数境界値テスト
=== 残日数境界値テスト開始 ===
準備: テストユーザーに10日付与
テスト1: 残日数0日での申請試行
テスト2: 残日数を超える申請
...
=== 残日数境界値テスト結果 ===
1. 残日数0日での申請: SUCCESS (残日数: 0日, 申請結果: 拒否（正常）)
2. 残日数超過申請: SUCCESS (残5日で10日申請: 拒否（正常）)
...

=== エッジケーステスト結果サマリー ===
1. 残日数境界値テスト: ✅ PASS
2. 無効データテスト: ✅ PASS
...

総合結果: 7/7 テスト成功
成功率: 100%
```

**成功の確認:**
- `✅ PASS` が表示されている
- `SUCCESS` が表示されている
- 成功率が100%または高い割合

**失敗の確認:**
- `❌ FAIL` が表示されている
- `FAILED` が表示されている
- エラーメッセージが表示されている

---

## テストデータのクリーンアップ

全テスト完了後、テストデータを削除する場合：

**関数名:** `cleanupTestData`

**処理内容:**
- 付与履歴から TEST で始まる利用者IDのデータを削除
- URL管理から TEST で始まる利用者IDのデータを削除

**実行タイミング:**
- 全テスト完了後
- 本番移行前（ただし開発環境は残すため不要）

---

## トラブルシューティング

### エラー: "ReferenceError: XXX is not defined"

**原因:** 関数が見つからない、またはファイルが正しくプッシュされていない

**対処:**
1. GASエディタでファイル一覧を確認
2. `test-edge-cases.js`、`test-data-integrity.js` が存在するか確認
3. 存在しない場合、再度デプロイ: `./scripts/deploy.sh`

### エラー: "Exception: Cannot read property 'XXX' of null"

**原因:** スプレッドシートまたはシートが見つからない

**対処:**
1. `Code.js` 内の `SPREADSHEET_ID` が正しいか確認
2. スプレッドシートが存在するか確認
3. 必要なシート（マスター、申請、URL管理、付与履歴）が存在するか確認

### エラー: "Exception: Service invoked too many times"

**原因:** GASの実行時間制限（6分）または実行回数制限に達した

**対処:**
1. テストを分割して実行（`runEdgeCaseTests` → `runDataIntegrityTests` → `runSystemIntegrationTests`）
2. 時間を空けて再実行

### 警告: テストが FAILED または WARNING

**原因:** データの不整合、テストデータの問題、実装の問題

**対処:**
1. ログで詳細なエラーメッセージを確認
2. 該当する機能の動作を個別に確認
3. 必要に応じてバグ修正

---

## テスト実行チェックリスト

### 事前準備
- [ ] GASエディタにアクセス可能
- [ ] スプレッドシートが開ける
- [ ] 必要なシートが全て存在する
- [ ] テストファイルがデプロイされている（v63以降）

### テスト実行
- [ ] エッジケース・境界値テスト実行（`runEdgeCaseTests`）
- [ ] データ整合性詳細確認テスト実行（`runDataIntegrityTests`）
- [ ] システム統合テスト実行（`runSystemIntegrationTests`）
- [ ] 全テスト実行（`runAllTests`）（オプション）

### テスト結果確認
- [ ] エッジケーステスト: 成功率を記録
- [ ] データ整合性テスト: 成功率を記録
- [ ] システム統合テスト: 成功率を記録
- [ ] 失敗したテストの詳細を記録

### 事後処理
- [ ] テスト結果を作業ログに記録
- [ ] 発見したバグをリストアップ
- [ ] テストデータクリーンアップ（必要に応じて）

---

## テスト結果の記録テンプレート

```markdown
## テスト実行結果

**実行日:** 2025-XX-XX
**実行者:** [名前]
**バージョン:** v63

### エッジケース・境界値テスト
- 実行時間: XX分XX秒
- 成功率: X/7 (XX%)
- 失敗したテスト: [テスト名]
- 備考: [特記事項]

### データ整合性詳細確認テスト
- 実行時間: XX分XX秒
- 成功率: X/6 (XX%)
- 失敗したテスト: [テスト名]
- 備考: [特記事項]

### システム統合テスト
- 実行時間: XX分XX秒
- 成功率: X/7 (XX%)
- 失敗したテスト: [テスト名]
- 備考: [特記事項]

### 発見した問題
1. [問題の説明]
2. [問題の説明]

### 次のアクション
- [ ] バグ修正: [詳細]
- [ ] 機能改善: [詳細]
```
