# 本番環境移行ガイド

## 移行スケジュール

**開発期間:** 2024年8月〜2024年12月（微調整・テスト期間）
**本番移行:** 2025年1月〜

---

## 環境分離方針

### 開発環境（現在のGASプロジェクト）

**用途:**
- 機能開発・テスト
- バグ修正
- システム検証

**GASプロジェクト情報:**
- Script ID: `1JBx6pQKBVB68Ud2pbQf6n2YmLYHeSWuM_2vV2hD9zfGdI6BC1MQJOY-6`
- Project ID: `polynomial-net-477401-k0`
- デプロイメントID: `AKfycbyJNqVvi4wYJwjXEc5Y9QF7qV-08M9uk4396sAo7Lu0i0lsY2RlCtbAPVMWaeYiKeKn`

**含まれるファイル:**
- src/ - 本番コード
- test/ - テストコード（11種類）
- テストデータ（TEST_XXX プレフィックス）

**スプレッドシート:**
- 開発用スプレッドシート（テストデータ含む）

### 本番環境（年明けに新規作成）

**用途:**
- 本番運用
- 実データ管理（153名）

**作成タイミング:**
- 2025年1月（UAT開始前）

**含まれるファイル:**
- src/ のみ（本番コード）
- test/ は含めない
- appsscript.json

**スプレッドシート:**
- 本番用スプレッドシート（実データ153名）

---

## 本番環境作成手順

### ステップ1: 本番用スプレッドシート作成

1. 新しいGoogleスプレッドシートを作成
2. シート名: `有給管理システム（本番）`
3. 必要なシートを作成:
   - マスター
   - 申請
   - URL管理
   - 付与履歴
   - 通知設定

4. 開発環境からシート構造をコピー（データは除く）
   - ヘッダー行のみコピー
   - データ検証ルールをコピー
   - 条件付き書式をコピー

### ステップ2: 本番用GASプロジェクト作成

```bash
# 1. 本番用ディレクトリ作成
mkdir yukyu-kanri-production
cd yukyu-kanri-production

# 2. 開発環境のsrcディレクトリのみコピー
cp -r ../yukyu-kanri/src ./
cp ../yukyu-kanri/appsscript.json ./

# 3. GASプロジェクトを新規作成
clasp create --type standalone --title "有給管理システム（本番）"

# 4. スプレッドシートIDを更新
# Code.js 内の SPREADSHEET_ID を本番スプレッドシートIDに変更

# 5. 初回デプロイ
clasp push
clasp deploy --description "本番環境 初回デプロイ"
```

### ステップ3: 本番データ移行

1. **マスターデータインポート**
   - `有給管理_移行データ.csv`（153名分）をインポート
   - 利用者番号、利用者名、残有給日数、備考を確認

2. **初回付与処理実行**
   - GASエディタで `performInitialGrant()` を実行
   - 全153名の付与履歴を作成

3. **URL生成**
   - GASエディタで `generateAllUserUrls()` を実行
   - 全利用者の個人専用URLを生成

4. **データ検証**
   - マスターシートと付与履歴の整合性確認
   - URL管理シートの確認
   - 残日数計算の確認

### ステップ4: Webアプリ公開設定

1. GASエディタで「デプロイ」→「新しいデプロイ」
2. デプロイタイプ: Webアプリ
3. 実行ユーザー: 自分
4. アクセスできるユーザー: 全員
5. デプロイ

### ステップ5: トリガー設定

本番環境で以下のトリガーを設定:

```javascript
setupAllTriggers()
```

**設定されるトリガー:**
- 毎日午前2時: データ整合性チェック（`checkDataIntegrity`）
- 毎日午前3時: 失効処理（`processExpiredLeaves`）
- 毎週月曜午前9時: 残日数アラート（`checkLowRemainingDaysAlerts`）
- 毎月1日午前4時: 月次レポート生成（`generateMonthlyReportEmail`）
- 毎年4月1日午前5時: 年度切り替え処理（`processFiscalYearChange`）

### ステップ6: 通知設定

1. 管理者画面で通知設定を確認
2. 通知メールアドレスを本番用に設定
3. テスト通知を送信して動作確認

---

## 本番移行前チェックリスト

### データ準備
- [ ] 本番用スプレッドシート作成完了
- [ ] マスターデータ（153名）準備完了
- [ ] シート構造のコピー完了
- [ ] データ検証ルール設定完了

### GASプロジェクト
- [ ] 本番用GASプロジェクト作成
- [ ] src/ディレクトリのみデプロイ
- [ ] SPREADSHEET_IDを本番用に変更
- [ ] Webアプリとして公開

### データ移行
- [ ] 初回付与処理実行
- [ ] URL生成完了
- [ ] データ整合性確認
- [ ] 残日数計算確認

### 機能確認
- [ ] 管理者画面の動作確認
- [ ] 個人専用ページの動作確認（サンプル数名）
- [ ] 有給申請フォームの動作確認
- [ ] 承認・却下機能の動作確認
- [ ] 通知機能の動作確認

### トリガー・自動処理
- [ ] 全トリガー設定完了
- [ ] 失効処理のテスト実行
- [ ] データ整合性チェックのテスト実行
- [ ] 月次レポートのテスト生成

### セキュリティ
- [ ] URLキーの一意性確認
- [ ] アクセス制御の動作確認
- [ ] 個人情報保護の確認

### ドキュメント
- [ ] ユーザーマニュアル作成
- [ ] 管理者マニュアル作成
- [ ] トラブルシューティングガイド作成
- [ ] 保守手順書作成

### UAT（ユーザー受け入れテスト）
- [ ] 利用者による個人ページ操作確認
- [ ] 管理者による管理画面操作確認
- [ ] 各種画面の使いやすさ評価
- [ ] フィードバック収集・反映

---

## 重要な注意事項

### 開発環境と本番環境の使い分け

**開発環境は引き続き保持:**
- 機能追加やバグ修正のテスト環境として継続使用
- テストデータで自由に実験可能
- 本番適用前の検証環境

**本番環境では:**
- 実データのみ
- テストコードなし
- 本番運用に特化

### データのバックアップ

**本番運用開始後の定期バックアップ:**
1. スプレッドシート全体をコピー（月1回）
2. 付与履歴シートをエクスポート（週1回）
3. マスターシートをエクスポート（週1回）

### トラブル時の対応

**開発環境で再現・修正:**
1. 本番環境で問題発生
2. 開発環境で同じデータを再現
3. 開発環境で修正・テスト
4. 本番環境に反映

---

## 本番移行後の開発フロー

### 機能追加・修正の流れ

1. **開発環境で実装**
   - 機能追加・バグ修正
   - テストコードで検証
   - 動作確認

2. **コードレビュー**
   - 実装内容の確認
   - セキュリティチェック
   - パフォーマンスチェック

3. **本番環境に反映**
   ```bash
   # 開発環境のsrcディレクトリを本番環境にコピー
   cd yukyu-kanri-production
   cp -r ../yukyu-kanri/src ./

   # 本番環境にプッシュ
   clasp push
   clasp deploy --description "v1.1: 機能追加"
   ```

4. **本番環境で動作確認**
   - 管理者で動作確認
   - 影響範囲の確認
   - ユーザーへの通知（必要に応じて）

---

## ロールバック手順

本番環境で問題が発生した場合のロールバック:

```bash
# 1. 前のバージョンを確認
clasp versions

# 2. 前のバージョンにロールバック
clasp deploy -i <デプロイメントID> -v <バージョン番号>
```

または、GASエディタから:
1. 「デプロイ」→「デプロイを管理」
2. 前のバージョンを選択
3. 「デプロイを編集」で前のバージョンに変更

---

## 連絡先・参照先

**開発環境リポジトリ:**
- GitHub: `https://github.com/toshi776/yukyu-kanri` (想定)
- ローカル: `/home/toshi776/project/yukyu-kanri`

**本番環境（作成後）:**
- GAS Script ID: （年明けに記載）
- Spreadsheet ID: （年明けに記載）
- Web App URL: （年明けに記載）

**ドキュメント:**
- 実装レポート: `docs/implementation-report.md`
- 作業ログ: `docs/worklog.md`
- このガイド: `docs/production-migration-guide.md`

---

## 更新履歴

| 日付 | 内容 | 担当 |
|------|------|------|
| 2025-11-14 | 初版作成（環境分離方針、移行手順） | Claude Code |
| 2025-01-XX | 本番環境作成時に更新予定 | |

---

## 参考: 開発環境でのテスト実施

年内は開発環境で以下のテストを実施予定:

1. **エッジケース・境界値テスト** (`runEdgeCaseTests()`)
2. **データ整合性詳細確認** (`runDataIntegrityTests()`)
3. **システム統合テスト** (`runSystemIntegrationTests()`)
4. **パフォーマンステスト**
5. **セキュリティテスト**

これらのテスト完了後、本番移行を実施。
