有給休暇管理システム　基本設計書（v2 反映版）
==============================================

作成日：2025‑06‑21  
最終更新：2025‑06‑21（GAS＋Sheets 詳細反映）

----------------------------------------------------------------
0. 位置付け
----------------------------------------------------------------
現行 Excel 台帳を **Google Apps Script（GAS）＋Google スプレッドシート＋HTML UI**
でクラウド化する MVP システムの基本設計。  
本書は開発・導入フェーズでの共通仕様を示す。

----------------------------------------------------------------
1. 背景と目的
----------------------------------------------------------------
- **課題**：ファイル乱立・手入力ミス・監査証跡不足・権限制御の甘さ 
- **目的**  
  1. 年休付与・取得・残数更新をワンストップ自動化  
  2. 2 年失効・年5日取得義務を確実判定  
  3. 人事・利用者双方の作業負荷を大幅削減

----------------------------------------------------------------
2. 対象範囲
----------------------------------------------------------------
| 機能 | 対応 | 備考 |
|------|------|------|
| 年次有給休暇 | 〇 | 本設計の中心 |
| 特別休暇 | △ | テーブル列のみ先行用意 |
| 勤怠/給与連携 | △ | 週次 CSV 出力 |

----------------------------------------------------------------
3. システム構成（決定）
----------------------------------------------------------------
```
┌───────────────────────────┐
│ Google Apps Script プロジェクト（PaidLeaveApp） │
│  ├─ Code.gs          (ルーティング / API)        │
│  ├─ SheetsService.gs (CRUD・残計算)              │
│  ├─ GrantBatch.gs    (付与・失効・義務バッチ)    │
│  ├─ EmailService.gs  (承認依頼 / 通知)          │
│  └─ ui/                                          │
│       ├─ form.html   (申請フォーム)              │
│       ├─ dash.html   (ダッシュボード)            │
│       └─ form.js     (クライアント検証)          │
└───────────────────────────┘
       ↑                       ↑
利用者：ブラウザ          承認者：Gmailワンクリック
```
*将来：FastAPI＋PostgreSQL＋React へ移行しやすいようモジュール分割*

----------------------------------------------------------------
4. データモデル
----------------------------------------------------------------
**Employee / LeaveGrant / LeaveUsage / Dashboard** の 4 テーブル構成  
詳細列定義は「データ項目レイアウト決定版.txt」を参照  fileciteturn0file0

----------------------------------------------------------------
5. 主要業務ルール
----------------------------------------------------------------
- **付与**：入社6か月後→以降毎年4/1一括付与  fileciteturn0file4  
- **日数**：週5日・週4日テーブル準拠  
- **残計算**：FIFO、0.5日単位、承認後控除  fileciteturn0file2  
- **失効**：付与＋2年で自動失効  
- **義務**：10日以上付与者を対象に10/1時点で未達メール  
- **履歴保持**：付与・取得履歴を5年間保存

----------------------------------------------------------------
6. 入力・承認フロー（GAS 実装）
----------------------------------------------------------------
| # | 画面/処理 | 概要 |
|---|-----------|------|
| ① 申請フォーム (`ui/form.html`) | Bootstrap＋HtmlService でモバイル対応 |
| ② 自動チェック | `onFormSubmit(e)`：残不足・日付重複検証 |
| ③ 承認依頼 | `EmailService.sendApprovalRequest()` |
| ④ 承認/却下 | `doGet?act=approve` でワンクリック |
| ⑤ 残高更新 | `SheetsService.allocateLeave()` |
| ⑥ 結果通知 | Gmail CC：上長 |
| ⑦ 月次リマインド | `GrantBatch.runMonthlyRemind()` |

----------------------------------------------------------------
7. トリガー／バッチ
----------------------------------------------------------------
| トリガー | 時刻 | 処理 |
|----------|------|------|
| **年次付与** | 4/1 00:30 | `runAnnualGrant()` |
| **失効処理** | 毎日 00:30 | `runDailyExpire()` |
| **月次義務** | 毎月1日 06:00 | `runMonthlyRemind()` |
| **残再集計** | 承認後＋毎晩 01:00 | `updateRemaining()` |

----------------------------------------------------------------
8. 非機能要件
----------------------------------------------------------------
| 区分 | 要件 |
|------|------|
| パフォーマンス | 200名規模で申請→承認完了 <5秒 |
| GAS 実行上限 | 1日実行時間 <90分（Google 制限内） |
| 可用性 | 99.5%（Google インフラ依存） |
| バックアップ | Sheets バージョン履歴＋週次 Drive Export |
| セキュリティ | Workspace SSO＋行保護＋監査ログ (IP・差分) |

----------------------------------------------------------------
9. 実装ロードマップ
----------------------------------------------------------------
| 週 | マイルストーン |
|----|----------------|
| 1  | テーブル雛形／Code.gs ルーティング完成 |
| 2  | 申請フォーム＋承認メール結線 |
| 3  | 残計算・付与/失効バッチ実装 |
| 4  | ダッシュボード・月次リマインド→パイロット運用 |

----------------------------------------------------------------
10. 回答提案（未決項目）
----------------------------------------------------------------
| # | 質問 | 提案回答（一般的推奨） |
|---|------|-----------------------|
| 1 | 承認代理者 | **あり**：上長不在時のため `delegate_id` を Employee に追加 |
| 2 | 通知チャネル | **Gmail** に加え **Slack Webhook** をオプション実装（後日） |
| 3 | 申請受付期限 | **原則：休暇前営業日17:00 まで**<br>当日申請は「体調不良」等理由付きで可 |
| 4 | 残少通知閾値 | **残5日以下** で本人、**残3日以下** で上長にも通知 |
| 5 | 部署メンバー残高閲覧 | **不可**：個人情報保護を優先（上長・人事のみ閲覧可） |
| 6 | 特別休暇 | `leave_type` 列で区別し、付与/残管理は別ロジック (次期) |
| 7 | 勤怠CSV | 週次自動エクスポート：`employee_id, date, leave_type, hours` |
| 8 | バックアップ先 | Google Drive ＋ **BigQuery スナップショット** 二重化 |
| 9 | 監査ログ詳細 | 行更新前後差分・実行ユーザ・IP を `AuditLog` シートに保存 |
|10 | Excel並行運用期間 | **1か月** で Excel を閲覧専用化し新規入力禁止 |

----------------------------------------------------------------
11. 確認が必要な残課題
----------------------------------------------------------------
- Slack Webhook 導入時の管理コスト・通知文章フォーマット  
- BigQuery バックアップの料金承認  
- AuditLog シートの保持期間（推奨5年）  
- 特別休暇ロジックの実装タイミング  

以上を踏まえ、改めてご確認ください。
