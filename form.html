<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æœ‰çµ¦ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    h2 {
      color: #4CAF50;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
      margin-top: 30px;
      font-size: 22px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      font-size: 18px;
    }
    
    input[type="date"], select {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 20px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    
    input[type="date"]:focus, select:focus {
      outline: 3px solid #4CAF50;
      outline-offset: 2px;
      border-color: #4CAF50;
    }
    
    input[type="date"]:invalid {
      border-color: #f44336;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 20px;
      width: 100%;
      font-weight: bold;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .info-box {
      background-color: #e8f5e9;
      border-left: 4px solid #4CAF50;
      padding: 20px;
      margin-bottom: 25px;
      font-size: 20px;
      line-height: 1.6;
    }
    
    .warning-box {
      background-color: #fff3cd;
      border-left: 4px solid #ff9800;
      padding: 20px;
      margin-bottom: 25px;
      color: #856404;
      font-size: 18px;
    }
    
    .error-box {
      background-color: #ffebee;
      border-left: 4px solid #f44336;
      padding: 20px;
      margin-bottom: 25px;
      color: #c62828;
      font-size: 18px;
      text-align: center;
    }
    
    .success {
      color: #4CAF50;
      font-size: 18px;
      margin-top: 10px;
      padding: 15px;
      background-color: #e8f5e9;
      border-radius: 4px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      color: #666;
      padding: 30px;
      font-size: 20px;
    }
    
    .remaining-days {
      font-size: 32px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 16px;
    }
    
    .history-table th {
      background-color: #4CAF50;
      color: white;
      padding: 12px;
      text-align: left;
      border: 1px solid #4CAF50;
    }
    
    .history-table td {
      padding: 12px;
      border: 1px solid #ddd;
    }
    
    .cancel-btn {
      background-color: #f44336;
      color: white;
      padding: 8px 20px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 16px;
      width: auto;
    }
    
    .status-canceled {
      color: #f44336;
      font-weight: bold;
    }
    
    /* æœ‰çµ¦äºˆå®šã‚¹ã‚¿ã‚¤ãƒ« */
    .upcoming-vacation {
      background-color: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .approved-vacation {
      background-color: #e8f5e9;
      border-left: 4px solid #4CAF50;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .vacation-date {
      font-size: 18px;
      font-weight: bold;
      color: #1976d2;
    }
    
    .approved-vacation .vacation-date {
      color: #2e7d32;
    }
    
    .vacation-status {
      color: #ff9800;
      font-weight: bold;
    }
    
    .vacation-approved {
      color: #4CAF50;
      font-weight: bold;
    }
    
    .no-upcoming-vacations {
      text-align: center;
      color: #666;
      padding: 20px;
      font-style: italic;
    }
    
    .vacation-section h4 {
      margin-bottom: 15px;
      color: #333;
      font-size: 16px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    
    /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šã‚¹ã‚¿ã‚¤ãƒ« */
    .required {
      color: #f44336;
      font-weight: bold;
      margin-left: 4px;
    }
    
    .help-text {
      font-size: 16px;
      color: #666;
      margin-top: 8px;
      line-height: 1.4;
    }
    
    /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»ãƒ›ãƒãƒ¼æ™‚ã®è¦–èªæ€§å‘ä¸Š */
    button:focus {
      outline: 3px solid #2e7d32;
      outline-offset: 2px;
    }
    
    .cancel-btn:focus {
      outline: 3px solid #c62828;
      outline-offset: 2px;
    }
    
    /* WCAG 2.1 AAæº–æ‹  - é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¯¾å¿œå¼·åŒ– */
    @media (prefers-contrast: high) {
      .info-box {
        border-left-width: 6px;
        background-color: #f0f8ff;
        border-color: #2e7d32;
      }
      
      .warning-box {
        border-left-width: 6px;
        background-color: #fffbf0;
        border-color: #e65100;
      }
      
      .error-box {
        border-left-width: 6px;
        background-color: #fff5f5;
        border-color: #d32f2f;
      }
      
      button {
        border: 2px solid #2e7d32;
      }
      
      input[type="date"], select {
        border-width: 3px;
      }
    }
    
    /* å‹•ä½œè»½æ¸›è¨­å®šå¯¾å¿œ */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å°‚ç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œå¼·åŒ– */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      h2 {
        font-size: 20px;
      }
      
      /* ã‚¿ãƒƒãƒæ“ä½œã®ãŸã‚ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºã‚’æ‹¡å¤§ */
      button {
        padding: 18px 30px;
        font-size: 18px;
        margin: 10px 0;
        min-height: 48px; /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æœ€å°ã‚µã‚¤ã‚º */
      }
      
      .cancel-btn {
        padding: 12px 24px;
        font-size: 14px;
        min-height: 44px;
      }
      
      /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
      input[type="date"], select {
        padding: 18px;
        font-size: 18px;
        min-height: 48px;
      }
      
      /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
      .history-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      .history-table thead,
      .history-table tbody,
      .history-table th,
      .history-table td,
      .history-table tr {
        display: block;
      }
      
      .history-table thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      
      .history-table tr {
        border: 1px solid #ddd;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 4px;
      }
      
      .history-table td {
        border: none;
        position: relative;
        padding-left: 50%;
        white-space: normal;
      }
      
      .history-table td:before {
        content: attr(data-label);
        position: absolute;
        left: 6px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: bold;
      }
      
      /* æœ‰çµ¦äºˆå®šã‚«ãƒ¼ãƒ‰ã®èª¿æ•´ */
      .upcoming-vacation,
      .approved-vacation {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .vacation-date {
        font-size: 16px;
      }
    }
    
    /* æ¥µå°ç”»é¢å¯¾å¿œ */
    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 22px;
      }
      
      .info-box,
      .warning-box,
      .error-box {
        padding: 15px;
        font-size: 16px;
      }
      
      .remaining-days {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div id="loadingContainer" class="container">
    <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
  
  <div id="errorContainer" class="container" style="display: none;">
    <h1>ã‚¨ãƒ©ãƒ¼</h1>
    <div class="error-box">
      <p id="errorMessage"></p>
      <p>æ­£ã—ã„URLã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
    </div>
  </div>
  
  <div id="mainContainer" style="display: none;">
    <div class="container">
      <h1 role="banner">
        <span class="sr-only">æœ‰çµ¦ä¼‘æš‡</span>ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ã€é–‹ç™ºç’°å¢ƒã€‘
      </h1>
      
      <div class="info-box">
        <strong style="font-size: 24px;"><span id="userName"></span> æ§˜</strong><br>
        <div style="margin-top: 10px;">
          ç¾åœ¨ã®æœ‰çµ¦æ®‹æ—¥æ•°: <span id="remaining" class="remaining-days"></span>
        </div>
      </div>
      
      <!-- æœ‰çµ¦äºˆå®šè¡¨ç¤º -->
      <div id="upcomingVacationsContainer" class="container">
        <h3>æœ‰çµ¦äºˆå®š</h3>
        
        <!-- æ‰¿èªæ¸ˆã¿ã®æœ‰çµ¦äºˆå®š -->
        <div id="approvedVacationsSection">
          <h4>ç¢ºå®šã—ãŸæœ‰çµ¦äºˆå®š</h4>
          <div id="approvedVacationsContent">
            <div style="text-align: center; color: #666; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
        
        <!-- ç”³è«‹ä¸­ã®æœ‰çµ¦äºˆå®š -->
        <div id="pendingVacationsSection">
          <h4>ç”³è«‹ä¸­ã®æœ‰çµ¦äºˆå®š</h4>
          <div id="pendingVacationsContent">
            <div style="text-align: center; color: #666; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
      </div>
      
      <div id="applicationForm">
        <div class="form-group">
          <label for="applyDate">
            ç”³è«‹ã™ã‚‹æ—¥ã‚’é¸ã‚“ã§ãã ã•ã„<span class="required" aria-label="å¿…é ˆé …ç›®">*</span>
          </label>
          <input 
            type="date" 
            id="applyDate" 
            aria-describedby="dateHelp dateValidation"
            aria-required="true"
            aria-invalid="false"
            required
          >
          <div id="dateHelp" class="help-text">
            æ˜æ—¥ä»¥é™ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆ3ãƒ¶æœˆä»¥å†…ï¼‰<br>
            <strong>æ³¨æ„:</strong> åœŸæ—¥ç¥æ—¥ãƒ»ä¼šç¤¾ä¼‘æ—¥ã¯è‡ªå‹•ã§ç¢ºèªã•ã‚Œã¾ã™
          </div>
          <div id="dateValidation" role="status" aria-live="polite" class="help-text"></div>
        </div>
        
        <div class="form-group">
          <label for="applyDays">ç”³è«‹ã™ã‚‹æ—¥æ•°</label>
          <select 
            id="applyDays" 
            aria-describedby="daysHelp"
            aria-invalid="false"
          >
            <option value="1" selected>1æ—¥ï¼ˆçµ‚æ—¥ï¼‰</option>
            <option value="0.5">0.5æ—¥ï¼ˆåŠæ—¥ï¼‰</option>
          </select>
          <div id="daysHelp" class="help-text">
            åŠæ—¥ã®å ´åˆã¯ã€åˆå‰ã¾ãŸã¯åˆå¾Œã®ã„ãšã‚Œã‹ãŒå¯¾è±¡ã¨ãªã‚Šã¾ã™<br>
            <small>â€» è©³ç´°ã¯ç”³è«‹å¾Œã«ä¸Šå¸ã«ã”ç¢ºèªãã ã•ã„</small>
          </div>
        </div>
        
        <div class="warning-box">
          â€» ç”³è«‹æ—¥ã®å‰æ—¥ã¾ã§ã¯å–ã‚Šæ¶ˆã—ãŒã§ãã¾ã™
        </div>
        
        <button 
          id="submitBtn" 
          onclick="submitApplication()"
          aria-describedby="submitMessage"
          type="button"
          class="main-submit-btn"
        >
          <span aria-hidden="true">ğŸ“…</span> ç”³è«‹ã™ã‚‹
        </button>
        <div id="submitMessage" role="alert" aria-live="assertive"></div>
      </div>
    </div>
    
    <div class="container">
      <h2>ç”³è«‹å±¥æ­´</h2>
      <div id="historyContent">
        <div class="loading">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var currentUser = null;
    var userId = null;
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded');
      initializeForm();
    });
    
    // åˆæœŸåŒ–å‡¦ç†
    function initializeForm() {
      console.log('åˆæœŸåŒ–é–‹å§‹');
      
      // GASã‹ã‚‰æ¸¡ã•ã‚ŒãŸuserIdã‚’ç¢ºèª
      if (typeof userIdFromGAS !== 'undefined' && userIdFromGAS) {
        userId = userIdFromGAS;
        console.log('userId from GAS:', userId);
      } else {
        // userIdãŒå–å¾—ã§ããªã„å ´åˆã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å…¥åŠ›
        userId = prompt('åˆ©ç”¨è€…ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '123456');
        if (!userId) {
          showError('åˆ©ç”¨è€…ç•ªå·ãŒå…¥åŠ›ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
          return;
        }
      }
      
      // æ—¥ä»˜ã®åˆæœŸè¨­å®š
      setupDateInput();
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
      loadUserInfo();
    }
    
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('errorContainer').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿
    function loadUserInfo() {
      console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿é–‹å§‹:', userId);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('findUseræˆåŠŸ:', result);
          if (result && result.found) {
            currentUser = result.user;
            showMainContent();
          } else {
            showError('åˆ©ç”¨è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ã‚¨ãƒ©ãƒ¼:', error);
          showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .findUser(userId);
    }
    
    // ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
    function showMainContent() {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'block';
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('remaining').textContent = currentUser.remaining + ' æ—¥';
      
      // æ®‹æ—¥æ•°ãŒ0ã®å ´åˆ
      if (currentUser.remaining <= 0) {
        document.getElementById('applicationForm').innerHTML = 
          '<div class="error-box">æœ‰çµ¦æ®‹æ—¥æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™</div>';
      }
      
      // ç”³è«‹å±¥æ­´èª­ã¿è¾¼ã¿
      loadApplicationHistory();
      
      // ç”³è«‹ä¸­ã®æœ‰çµ¦äºˆå®šã‚’èª­ã¿è¾¼ã¿
      loadUpcomingVacations();
    }
    
    // æœ‰çµ¦äºˆå®šèª­ã¿è¾¼ã¿
    function loadUpcomingVacations() {
      console.log('=== æœ‰çµ¦äºˆå®šèª­ã¿è¾¼ã¿é–‹å§‹ ===');
      
      google.script.run
        .withSuccessHandler(function(applications) {
          console.log('æœ‰çµ¦äºˆå®šå–å¾—æˆåŠŸ:', applications);
          displayVacations(applications);
        })
        .withFailureHandler(function(error) {
          console.error('æœ‰çµ¦äºˆå®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          document.getElementById('approvedVacationsContent').innerHTML = 
            '<div class="no-upcoming-vacations">æœ‰çµ¦äºˆå®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
          document.getElementById('pendingVacationsContent').innerHTML = 
            '<div class="no-upcoming-vacations">æœ‰çµ¦äºˆå®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        })
        .getUserApplications(userId);
    }
    
    // æœ‰çµ¦äºˆå®šè¡¨ç¤ºï¼ˆæ‰¿èªæ¸ˆã¿ã¨ç”³è«‹ä¸­ã‚’åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
    function displayVacations(applications) {
      var approvedContent = document.getElementById('approvedVacationsContent');
      var pendingContent = document.getElementById('pendingVacationsContent');
      
      if (!applications || applications.length === 0) {
        approvedContent.innerHTML = '<div class="no-upcoming-vacations">ç¢ºå®šã—ãŸæœ‰çµ¦äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        pendingContent.innerHTML = '<div class="no-upcoming-vacations">ç”³è«‹ä¸­ã®æœ‰çµ¦äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
      var today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // ç”³è«‹æ—¥ãŒä»Šæ—¥ä»¥é™ã®ã‚‚ã®ã§ã€å´ä¸‹æ¸ˆã¿ã§ãªã„ã‚‚ã®ã‚’æŠ½å‡º
      var futureApplications = applications.filter(function(app) {
        var applyDate = new Date(app.applyDate);
        return applyDate >= today && app.status !== 'Rejected';
      });
      
      // æ‰¿èªæ¸ˆã¿ã¨ç”³è«‹ä¸­ã«åˆ†ã‘ã‚‹
      var approvedVacations = futureApplications.filter(function(app) {
        return app.status === 'Approved';
      });
      
      var pendingVacations = futureApplications.filter(function(app) {
        return app.status === 'Pending';
      });
      
      // ç”³è«‹æ—¥ã§ã‚½ãƒ¼ãƒˆ
      approvedVacations.sort(function(a, b) {
        return new Date(a.applyDate) - new Date(b.applyDate);
      });
      
      pendingVacations.sort(function(a, b) {
        return new Date(a.applyDate) - new Date(b.applyDate);
      });
      
      // æ‰¿èªæ¸ˆã¿æœ‰çµ¦äºˆå®šã®è¡¨ç¤º
      if (approvedVacations.length === 0) {
        approvedContent.innerHTML = '<div class="no-upcoming-vacations">ç¢ºå®šã—ãŸæœ‰çµ¦äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      } else {
        var approvedHtml = '';
        approvedVacations.forEach(function(vacation) {
          var daysText = vacation.applyDays === 0.5 ? 'ï¼ˆåŠæ—¥ï¼‰' : '';
          approvedHtml += '<div class="approved-vacation">';
          approvedHtml += '<div class="vacation-date">' + vacation.applyDate + daysText + '</div>';
          approvedHtml += '<div class="vacation-approved">ç¢ºå®š</div>';
          approvedHtml += '</div>';
        });
        approvedContent.innerHTML = approvedHtml;
      }
      
      // ç”³è«‹ä¸­æœ‰çµ¦äºˆå®šã®è¡¨ç¤º
      if (pendingVacations.length === 0) {
        pendingContent.innerHTML = '<div class="no-upcoming-vacations">ç”³è«‹ä¸­ã®æœ‰çµ¦äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      } else {
        var pendingHtml = '';
        pendingVacations.forEach(function(vacation) {
          var daysText = vacation.applyDays === 0.5 ? 'ï¼ˆåŠæ—¥ï¼‰' : '';
          pendingHtml += '<div class="upcoming-vacation">';
          pendingHtml += '<div class="vacation-date">' + vacation.applyDate + daysText + '</div>';
          pendingHtml += '<div class="vacation-status">æ‰¿èªå¾…ã¡</div>';
          pendingHtml += '</div>';
        });
        pendingContent.innerHTML = pendingHtml;
      }
    }
    
    // ç”³è«‹å±¥æ­´èª­ã¿è¾¼ã¿
    function loadApplicationHistory() {
      console.log('=== ç”³è«‹å±¥æ­´èª­ã¿è¾¼ã¿é–‹å§‹ ===');
      console.log('userId:', userId);
      
      google.script.run
        .withSuccessHandler(function(applications) {
          console.log('å±¥æ­´å–å¾—æˆåŠŸ');
          console.log('å–å¾—ãƒ‡ãƒ¼ã‚¿:', applications);
          console.log('ãƒ‡ãƒ¼ã‚¿å‹:', typeof applications);
          console.log('é…åˆ—ã‹ã©ã†ã‹:', Array.isArray(applications));
          console.log('ä»¶æ•°:', applications ? applications.length : 'null or undefined');
          
          if (applications && applications.length > 0) {
            console.log('æœ€åˆã®ãƒ‡ãƒ¼ã‚¿:', applications[0]);
            console.log('ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼:', Object.keys(applications[0]));
          }
          
          displayHistory(applications);
        })
        .withFailureHandler(function(error) {
          console.error('å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message);
          document.getElementById('historyContent').innerHTML = 
            '<div style="color: red;">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</div>';
        })
        .getUserApplications(userId);  // â† testSimpleReturnã§ã¯ãªãã€getUserApplicationsã«æˆ»ã™
    }
    
    // å±¥æ­´è¡¨ç¤º
    function displayHistory(applications) {
      var content = document.getElementById('historyContent');
      
      if (!applications || applications.length === 0) {
        content.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ç”³è«‹å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      // å–æ¶ˆæ¸ˆã¿ã€å´ä¸‹æ¸ˆã¿ã®å±¥æ­´ã¨å–ã‚Šæ¶ˆã—ä¸å¯ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’é™¤å¤–
      var activeApplications = applications.filter(function(app) {
        return app.status !== 'Canceled' && app.status !== 'Rejected' && app.canCancel === true;
      });
      
      if (activeApplications.length === 0) {
        content.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ç”³è«‹å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      var html = '<table class="history-table"><thead><tr>' +
                 '<th>ç”³è«‹æ—¥</th><th>æ—¥æ•°</th><th>ç”³è«‹ã—ãŸæ—¥æ™‚</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>' +
                 '</tr></thead><tbody>';
      
      activeApplications.forEach(function(app) {
        var daysText = app.applyDays === 0.5 ? '0.5æ—¥' : '1æ—¥';
        html += '<tr>';
        html += '<td>' + app.applyDate + '</td>';
        html += '<td>' + daysText + '</td>';
        html += '<td>' + app.timestamp + '</td>';
        html += '<td>' + (app.status === 'Approved' ? 'æ‰¿èªæ¸ˆ' : 'ç”³è«‹ä¸­') + '</td>';
        html += '<td>';
        if (app.canCancel) {
          html += '<button class="cancel-btn" onclick="cancelApplication(' + app.rowNumber + ')">å–ã‚Šæ¶ˆã™</button>';
        } else {
          html += '<span style="color: #999;">å–æ¶ˆä¸å¯</span>';
        }
        html += '</td></tr>';
      });
      
      html += '</tbody></table>';
      content.innerHTML = html;
    }
    
    // ç”³è«‹é€ä¿¡ï¼ˆç”»é¢æ›´æ–°ç‰ˆï¼‰
    function submitApplication() {
      var applyDate = document.getElementById('applyDate').value;
      var applyDays = parseFloat(document.getElementById('applyDays').value);
      
      // å…¥åŠ›æ¤œè¨¼
      var validationResult = validateApplicationInput(applyDate, applyDays);
      if (!validationResult.isValid) {
        showValidationError(validationResult.message);
        return;
      }
      
      // æ—¥ä»˜ã‚’æ—¥æœ¬èªå½¢å¼ã§è¡¨ç¤º
      var dateObj = new Date(applyDate);
      var formattedDate = dateObj.getFullYear() + 'å¹´' + 
                          (dateObj.getMonth() + 1) + 'æœˆ' + 
                          dateObj.getDate() + 'æ—¥';
      
      var daysText = applyDays === 0.5 ? '0.5æ—¥ï¼ˆåŠæ—¥ï¼‰' : '1æ—¥';
      
      if (!confirm(formattedDate + ' ã«' + daysText + 'ã®æœ‰çµ¦ã‚’ç”³è«‹ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('submitBtn').textContent = 'é€ä¿¡ä¸­...';
      document.getElementById('submitMessage').innerHTML = ''; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
      
      google.script.run
        .withSuccessHandler(function(result) {
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          showSuccessMessage('ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼ æ®‹æ—¥æ•°: ' + result.newRemaining + 'æ—¥');
          
          // ç”»é¢ã‚’å…ƒã«æˆ»ã™ï¼ˆå°‘ã—é…ã‚‰ã›ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
          setTimeout(function() {
            refreshScreen();
          }, 2000);
        })
        .withFailureHandler(function(error) {
          showValidationError('ç”³è«‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          document.getElementById('submitBtn').disabled = false;
          document.getElementById('submitBtn').textContent = 'ç”³è«‹ã™ã‚‹';
        })
        .submitRequest({
          userId: userId,
          applyDate: applyDate,
          applyDays: applyDays
        });
    }

    // ç”³è«‹å–æ¶ˆï¼ˆç”»é¢æ›´æ–°ç‰ˆï¼‰
    function cancelApplication(rowNumber) {
      if (!showConfirmDialog('ã“ã®ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      // å–ã‚Šæ¶ˆã—å‡¦ç†ä¸­ã®è¡¨ç¤º
      var messageElement = document.getElementById('submitMessage');
      messageElement.innerHTML = '<div class="info-box">ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ä¸­...</div>';
      
      google.script.run
        .withSuccessHandler(function(result) {
          showSuccessMessage('å–ã‚Šæ¶ˆã—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æœ‰çµ¦æ®‹æ—¥æ•°: ' + result.newRemaining + 'æ—¥');
          
          // ç”»é¢ã‚’å…ƒã«æˆ»ã™
          setTimeout(function() {
            refreshScreen();
          }, 2000);
        })
        .withFailureHandler(function(error) {
          if (error.message && (error.message.includes('æ‰¿èªæ¸ˆã¿') || error.message.includes('å´ä¸‹æ¸ˆã¿') || error.message.includes('å‡¦ç†ã§ããªã„çŠ¶æ…‹'))) {
            showValidationError('ã“ã®ç”³è«‹ã¯æ—¢ã«ç®¡ç†è€…ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ€æ–°ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
            setTimeout(function() {
              refreshScreen();
            }, 3000);
          } else {
            showValidationError('å–ã‚Šæ¶ˆã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          }
        })
        .cancelUserApplication({
          userId: userId,
          rowNumber: rowNumber
        });
    }

    // å…¥åŠ›æ¤œè¨¼é–¢æ•°ï¼ˆå¼·åŒ–ç‰ˆï¼‰
    function validateApplicationInput(applyDate, applyDays) {
      try {
        // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
        if (!applyDate) {
          updateAriaInvalid('applyDate', true);
          return { 
            isValid: false, 
            message: 'ç”³è«‹æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„',
            field: 'applyDate'
          };
        }
        
        // æ—¥ä»˜å½¢å¼ãƒã‚§ãƒƒã‚¯
        var dateObj = new Date(applyDate);
        if (isNaN(dateObj.getTime())) {
          updateAriaInvalid('applyDate', true);
          return { 
            isValid: false, 
            message: 'æ­£ã—ã„æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„',
            field: 'applyDate'
          };
        }
        
        // éå»æ—¥ãƒã‚§ãƒƒã‚¯
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        dateObj.setHours(0, 0, 0, 0);
        
        if (dateObj <= today) {
          updateAriaInvalid('applyDate', true);
          return { 
            isValid: false, 
            message: 'ç”³è«‹æ—¥ã¯æ˜æ—¥ä»¥é™ã‚’é¸æŠã—ã¦ãã ã•ã„',
            field: 'applyDate'
          };
        }
        
        // 3ãƒ¶æœˆå…ˆã¾ã§ã®åˆ¶é™
        var maxDate = new Date();
        maxDate.setMonth(maxDate.getMonth() + 3);
        if (dateObj > maxDate) {
          updateAriaInvalid('applyDate', true);
          return { 
            isValid: false, 
            message: 'ç”³è«‹æ—¥ã¯3ãƒ¶æœˆä»¥å†…ã§é¸æŠã—ã¦ãã ã•ã„',
            field: 'applyDate'
          };
        }
        
        // æ—¥æ•°ãƒã‚§ãƒƒã‚¯
        if (applyDays !== 1 && applyDays !== 0.5) {
          updateAriaInvalid('applyDays', true);
          return { 
            isValid: false, 
            message: 'ç”³è«‹æ—¥æ•°ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“',
            field: 'applyDays'
          };
        }
        
        // æ®‹æ—¥æ•°ãƒã‚§ãƒƒã‚¯
        if (currentUser && applyDays > currentUser.remaining) {
          updateAriaInvalid('applyDays', true);
          return { 
            isValid: false, 
            message: 'æœ‰çµ¦æ®‹æ—¥æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆæ®‹ã‚Š: ' + currentUser.remaining + 'æ—¥ã€ç”³è«‹: ' + applyDays + 'æ—¥ï¼‰',
            field: 'applyDays'
          };
        }
        
        // ç¥æ—¥ãƒ»ä¼‘æ—¥ãƒã‚§ãƒƒã‚¯
        var holidayCheck = checkHolidaysAndWeekends(dateObj);
        if (!holidayCheck.isValid) {
          updateAriaInvalid('applyDate', true);
          return holidayCheck;
        }
        
        // ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå ´åˆ
        updateAriaInvalid('applyDate', false);
        updateAriaInvalid('applyDays', false);
        
        return { isValid: true };
        
      } catch (error) {
        console.error('æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
        return { 
          isValid: false, 
          message: 'æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚' 
        };
      }
    }
    
    // ç¥æ—¥ãƒ»ä¼‘æ—¥ãƒã‚§ãƒƒã‚¯é–¢æ•°
    function checkHolidaysAndWeekends(dateObj) {
      var dayOfWeek = dateObj.getDay();
      var month = dateObj.getMonth() + 1;
      var date = dateObj.getDate();
      
      // åœŸæ—¥ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šï¼‰
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        var dayName = dayOfWeek === 0 ? 'æ—¥æ›œæ—¥' : 'åœŸæ›œæ—¥';
        return { 
          isValid: false, 
          message: dayName + 'ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚ä¼‘æ—¥ã®æœ‰çµ¦ç”³è«‹ã¯é€šå¸¸ä¸è¦ã§ã™ã€‚å¿…è¦ãªå ´åˆã¯ä¸Šå¸ã«ã”ç›¸è«‡ãã ã•ã„ã€‚',
          isWarning: true,
          field: 'applyDate'
        };
      }
      
      // å›ºå®šç¥æ—¥ãƒã‚§ãƒƒã‚¯
      var nationalHolidays = {
        '1-1': 'å…ƒæ—¥',
        '2-11': 'å»ºå›½è¨˜å¿µæ—¥',
        '2-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
        '4-29': 'æ˜­å’Œã®æ—¥',
        '5-3': 'æ†²æ³•è¨˜å¿µæ—¥',
        '5-4': 'ã¿ã©ã‚Šã®æ—¥',
        '5-5': 'ã“ã©ã‚‚ã®æ—¥',
        '8-11': 'å±±ã®æ—¥',
        '11-3': 'æ–‡åŒ–ã®æ—¥',
        '11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
        '12-29': 'å¹´æœ«ä¼‘æš©',
        '12-30': 'å¹´æœ«ä¼‘æš©',
        '12-31': 'å¹´æœ«ä¼‘æš©'
      };
      
      var dateKey = month + '-' + date;
      if (nationalHolidays[dateKey]) {
        return {
          isValid: false,
          message: 'é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã¯' + nationalHolidays[dateKey] + 'ã§ã™ã€‚ç¥æ—¥ã®æœ‰çµ¦ç”³è«‹ã¯é€šå¸¸ä¸è¦ã§ã™ã€‚',
          isWarning: true,
          field: 'applyDate'
        };
      }
      
      // ä¼šç¤¾ä¼‘æ—¥ï¼ˆãŠç›†ä¼‘ã¿ï¼‰
      if (month === 8 && date >= 13 && date <= 16) {
        return {
          isValid: false,
          message: 'é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã¯ãŠç›†ä¼‘ã¿æœŸé–“ä¸­ã§ã™ã€‚ä¼šç¤¾ä¼‘æ—¥ã®æœ‰çµ¦ç”³è«‹ã¯é€šå¸¸ä¸è¦ã§ã™ã€‚',
          isWarning: true,
          field: 'applyDate'
        };
      }
      
      return { isValid: true };
    }
    
    // ARIAå±æ€§æ›´æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function updateAriaInvalid(fieldId, isInvalid) {
      var element = document.getElementById(fieldId);
      if (element) {
        element.setAttribute('aria-invalid', isInvalid.toString());
      }
    }
    
    // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆå¼·åŒ–ç‰ˆï¼‰
    function showValidationError(message, isWarning = false) {
      var messageElement = document.getElementById('submitMessage');
      var className = isWarning ? 'warning-box' : 'error-box';
      var ariaLabel = isWarning ? 'è­¦å‘Š' : 'ã‚¨ãƒ©ãƒ¼';
      
      // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¼·åŒ–
      messageElement.innerHTML = '<div class="' + className + '" role="alert" aria-live="assertive">' +
        '<span class="sr-only">' + ariaLabel + ': </span>' + message + '</div>';
      
      // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      messageElement.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center',
        inline: 'nearest'
      });
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç§»å‹•ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ï¼‰
      setTimeout(function() {
        var alertElement = messageElement.querySelector('[role="alert"]');
        if (alertElement && alertElement.focus) {
          alertElement.setAttribute('tabindex', '-1');
          alertElement.focus();
        }
      }, 100);
    }
    
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆå¼·åŒ–ç‰ˆï¼‰
    function showSuccessMessage(message) {
      var messageElement = document.getElementById('submitMessage');
      messageElement.innerHTML = '<div class="success" role="status" aria-live="polite">' +
        '<span class="sr-only">æˆåŠŸ: </span>' + 
        '<span aria-hidden="true">âœ“</span> ' + message + '</div>';
      
      messageElement.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center',
        inline: 'nearest'
      });
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç§»å‹•
      setTimeout(function() {
        var statusElement = messageElement.querySelector('[role="status"]');
        if (statusElement && statusElement.focus) {
          statusElement.setAttribute('tabindex', '-1');
          statusElement.focus();
        }
      }, 100);
    }
    
    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆå°†æ¥çš„ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã«ç½®ãæ›ãˆå¯èƒ½ï¼‰
    function showConfirmDialog(message) {
      return confirm(message); // ç¾çŠ¶ã¯confirmã‚’ä½¿ç”¨ã€å°†æ¥çš„ã«æ”¹å–„äºˆå®š
    }
    
    // æ¤œè¨¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¼·åŒ–ç‰ˆï¼‰
    function clearValidationMessage() {
      document.getElementById('submitMessage').innerHTML = '';
      document.getElementById('dateValidation').innerHTML = '';
      
      // ARIAå±æ€§ã‚’ãƒªã‚»ãƒƒãƒˆ
      updateAriaInvalid('applyDate', false);
      updateAriaInvalid('applyDays', false);
    }
    
    // æ—¥ä»˜å…¥åŠ›ã®è¨­å®š
    function setupDateInput() {
      var dateInput = document.getElementById('applyDate');
      var tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æ˜æ—¥ã«è¨­å®š
      dateInput.value = tomorrow.toISOString().split('T')[0];
      
      // æœ€å°æ—¥ä»˜ã‚’æ˜æ—¥ã«è¨­å®š
      dateInput.min = tomorrow.toISOString().split('T')[0];
      
      // æœ€å¤§æ—¥ä»˜ã‚’3ãƒ¶æœˆå¾Œã«è¨­å®š
      var maxDate = new Date();
      maxDate.setMonth(maxDate.getMonth() + 3);
      dateInput.max = maxDate.toISOString().split('T')[0];
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼ã®è¿½åŠ ï¼ˆå¼·åŒ–ç‰ˆï¼‰
      dateInput.addEventListener('change', function() {
        performRealTimeValidation(this.value, parseFloat(document.getElementById('applyDays').value));
      });
      
      // inputã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚æ¤œè¨¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šï¼‰
      dateInput.addEventListener('input', function() {
        // å…¥åŠ›ä¸­ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
        var validationDiv = document.getElementById('dateValidation');
        if (this.value) {
          var dateObj = new Date(this.value);
          var today = new Date();
          today.setHours(0, 0, 0, 0);
          dateObj.setHours(0, 0, 0, 0);
          
          if (dateObj <= today) {
            validationDiv.innerHTML = '<span style="color: #f44336;">âš  æ˜æ—¥ä»¥é™ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
          } else {
            validationDiv.innerHTML = '';
          }
        } else {
          validationDiv.innerHTML = '';
        }
      });
      
      // æ—¥æ•°å¤‰æ›´æ™‚ã®æ¤œè¨¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰
      document.getElementById('applyDays').addEventListener('change', function() {
        var applyDate = document.getElementById('applyDate').value;
        if (applyDate) {
          performRealTimeValidation(applyDate, parseFloat(this.value));
        }
        
        // æ—¥æ•°å¤‰æ›´æ™‚ã®è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        var selectedDays = parseFloat(this.value);
        var remainingDays = currentUser ? currentUser.remaining : 0;
        
        if (selectedDays > remainingDays) {
          showValidationError('æœ‰çµ¦æ®‹æ—¥æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆæ®‹ã‚Š: ' + remainingDays + 'æ—¥ï¼‰');
        } else if (selectedDays === 0.5) {
          var validationDiv = document.getElementById('dateValidation');
          validationDiv.innerHTML = '<span style="color: #2196f3;">â„¹ åŠæ—¥ä¼‘æš§ã®è©³ç´°ã¯ç”³è«‹å¾Œã«ä¸Šå¸ã«ã”ç¢ºèªãã ã•ã„</span>';
        }
      });
    }
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼å®Ÿè¡Œé–¢æ•°
    function performRealTimeValidation(applyDate, applyDays) {
      clearValidationMessage();
      var validationDiv = document.getElementById('dateValidation');
      validationDiv.innerHTML = '';
      
      if (!applyDate) return;
      
      var validationResult = validateApplicationInput(applyDate, applyDays);
      
      if (!validationResult.isValid) {
        if (validationResult.isWarning) {
          // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
          showValidationError(validationResult.message, true);
        } else {
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
          showValidationError(validationResult.message, false);
        }
      } else {
        // æˆåŠŸæ™‚ã¯ç°¡å˜ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        validationDiv.innerHTML = '<span style="color: #4CAF50;">âœ“ ç”³è«‹å¯èƒ½ãªæ—¥ä»˜ã§ã™</span>';
      }
    }

    // ç”»é¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
    function refreshScreen() {
      console.log('ç”»é¢ã‚’æ›´æ–°ã—ã¾ã™');
      
      // 1. ç”³è«‹æ—¥ã‚’æ˜æ—¥ã«ãƒªã‚»ãƒƒãƒˆ
      var tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('applyDate').value = tomorrow.toISOString().split('T')[0];
      
      // 2. ç”³è«‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('submitBtn').textContent = 'ç”³è«‹ã™ã‚‹';
      
      // 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('submitMessage').innerHTML = '';
      
      // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å†å–å¾—ã—ã¦æ›´æ–°
      loadUserInfo();
      
      // 5. ç”³è«‹ä¸­ã®æœ‰çµ¦äºˆå®šã‚’å†èª­ã¿è¾¼ã¿
      loadUpcomingVacations();
    }
  </script>
</body>
</html>