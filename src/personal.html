<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æœ‰çµ¦ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - å€‹äººãƒšãƒ¼ã‚¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
      font-weight: 300;
    }
    
    .header .user-info {
      font-size: 1.2em;
      opacity: 0.9;
    }
    
    .remaining-days {
      background: white;
      color: #4CAF50;
      display: inline-block;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 2.5em;
      font-weight: bold;
      margin: 20px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .remaining-days small {
      font-size: 0.4em;
      display: block;
      margin-top: 5px;
      font-weight: normal;
    }
    
    .content {
      padding: 30px;
    }
    
    .section {
      margin-bottom: 40px;
    }
    
    .section h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
      font-size: 1.5em;
      font-weight: 400;
    }
    
    .apply-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      border-left: 5px solid #4CAF50;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      font-size: 1.1em;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .btn {
      display: inline-block;
      padding: 15px 30px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      text-align: center;
      min-width: 200px;
    }
    
    .btn:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .applications-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .applications-table th {
      background: #f8f9fa;
      padding: 15px;
      text-align: left;
      font-weight: bold;
      color: #555;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .applications-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .applications-table tr:last-child td {
      border-bottom: none;
    }
    
    .applications-table tr:hover {
      background: #f8f9fa;
    }
    
    .status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      text-align: center;
      min-width: 80px;
      display: inline-block;
    }
    
    .status.pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .status.approved {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.rejected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .cancel-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.9em;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .cancel-btn:hover {
      background: #c82333;
    }
    
    .cancel-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    
    .no-applications {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
    }
    
    .alert {
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      font-weight: bold;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .footer {
      background: #f8f9fa;
      padding: 20px;
      text-align: center;
      color: #666;
      font-size: 0.9em;
    }
    
    .current-date {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      font-size: 1em;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .header {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 1.5em;
      }
      
      .remaining-days {
        font-size: 2em;
        padding: 12px 25px;
      }
      
      .content {
        padding: 20px;
      }
      
      .applications-table {
        font-size: 0.9em;
      }
      
      .applications-table th, .applications-table td {
        padding: 10px 8px;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>æœ‰çµ¦ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div class="user-info"><?= userName ?>ã•ã‚“ã®å°‚ç”¨ãƒšãƒ¼ã‚¸</div>
      <div class="remaining-days">
        <?= remainingDays ?>
        <small>æ—¥</small>
      </div>
      <div class="current-date"><?= currentDate ?> ç¾åœ¨</div>
    </div>
    
    <div class="content">
      <!-- æœ‰çµ¦ç”³è«‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section">
        <h2>ğŸ“ æœ‰çµ¦ç”³è«‹</h2>
        <div class="apply-section">
          <form id="leaveForm">
            <div class="form-group">
              <label for="applyDate">ç”³è«‹æ—¥</label>
              <input type="date" id="applyDate" name="applyDate" required>
            </div>
            
            <div class="form-group">
              <label for="applyDays">ç”³è«‹æ—¥æ•°</label>
              <select id="applyDays" name="applyDays">
                <option value="1">1æ—¥</option>
                <option value="0.5">0.5æ—¥ï¼ˆåŠæ—¥ï¼‰</option>
              </select>
            </div>
            
            <button type="submit" class="btn" id="submitBtn">
              æœ‰çµ¦ç”³è«‹ã‚’é€ä¿¡
            </button>
          </form>
        </div>
      </div>
      
      <!-- ç”³è«‹å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section">
        <h2>ğŸ“‹ ç”³è«‹å±¥æ­´</h2>

        <div id="applicationHistoryContainer">
        <? if (applications && applications.length > 0) { ?>
          <table class="applications-table">
            <thead>
              <tr>
                <th>ç”³è«‹æ—¥</th>
                <th>æ—¥æ•°</th>
                <th>ç”³è«‹æ—¥æ™‚</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <? for (var i = 0; i < applications.length; i++) { ?>
                <tr>
                  <td><?= applications[i].applyDate ?></td>
                  <td><?= applications[i].applyDays === 0.5 ? '0.5æ—¥' : '1æ—¥' ?></td>
                  <td><?= applications[i].timestamp ?></td>
                  <td>
                    <span class="status <?= applications[i].status.toLowerCase() ?>">
                      <?= applications[i].status === 'Pending' ? 'æ‰¿èªå¾…ã¡' : 
                          applications[i].status === 'Approved' ? 'æ‰¿èªæ¸ˆã¿' : 
                          applications[i].status === 'Rejected' ? 'å´ä¸‹' : applications[i].status ?>
                    </span>
                  </td>
                  <td>
                    <? if (applications[i].canCancel && applications[i].status === 'Pending') { ?>
                      <button class="cancel-btn" onclick="cancelApplication(<?= applications[i].rowNumber ?>, '<?= applications[i].applyDate ?>')">
                        å–æ¶ˆ
                      </button>
                    <? } else { ?>
                      <span style="color: #999;">-</span>
                    <? } ?>
                  </td>
                </tr>
              <? } ?>
            </tbody>
          </table>
        <? } else { ?>
          <div class="no-applications">
            ã¾ã ç”³è«‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        <? } ?>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>æœ‰çµ¦ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | ãŠå•ã„åˆã‚ã›ã¯äººäº‹éƒ¨é–€ã¾ã§</p>
      <p style="margin-top: 10px; font-size: 0.8em; color: #999;">
        ğŸ” ã“ã®ãƒšãƒ¼ã‚¸ã¯<?= userName ?>ã•ã‚“å°‚ç”¨ã§ã™
      </p>
    </div>
  </div>

  <script>
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’JavaScriptå¤‰æ•°ã¨ã—ã¦è¨­å®š
    var userId = '<?= userId ?>';
    var userName = '<?= userName ?>';
    var remainingDays = <?= remainingDays ?>;
    
    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã®æœ€å°æ—¥ä»˜ã«è¨­å®š
    document.addEventListener('DOMContentLoaded', function() {
      var today = new Date();
      var tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      var dateInput = document.getElementById('applyDate');
      dateInput.min = tomorrow.toISOString().split('T')[0];
      
      // 3ãƒ¶æœˆå¾Œã¾ã§ã«åˆ¶é™
      var maxDate = new Date(today);
      maxDate.setMonth(maxDate.getMonth() + 3);
      dateInput.max = maxDate.toISOString().split('T')[0];
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('leaveForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      var submitBtn = document.getElementById('submitBtn');
      var applyDate = document.getElementById('applyDate').value;
      var applyDays = parseFloat(document.getElementById('applyDays').value);
      
      if (!applyDate) {
        showAlert('ç”³è«‹æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      // æ®‹æ—¥æ•°ãƒã‚§ãƒƒã‚¯
      if (remainingDays < applyDays) {
        showAlert('æœ‰çµ¦æ®‹æ—¥æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆæ®‹ã‚Š' + remainingDays + 'æ—¥ï¼‰', 'error');
        return;
      }
      
      // é€ä¿¡ä¸­ã®çŠ¶æ…‹ã«å¤‰æ›´
      submitBtn.disabled = true;
      submitBtn.textContent = 'é€ä¿¡ä¸­...';
      
      // Google Apps Scriptã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—
      console.log('ğŸ“¤ ç”³è«‹é€ä¿¡é–‹å§‹...', {userId: userId, applyDate: applyDate, applyDays: applyDays});

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);

          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          submitBtn.disabled = false;
          submitBtn.textContent = 'æœ‰çµ¦ç”³è«‹ã‚’é€ä¿¡';

          if (result.success) {
            console.log('âœ… ç”³è«‹æˆåŠŸ - æ–°ã—ã„æ®‹æ—¥æ•°:', result.newRemaining);

            // æ®‹æ—¥æ•°ã‚’æ›´æ–°
            remainingDays = result.newRemaining;
            updateRemainingDaysDisplay(result.newRemaining);

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('applyDate').value = '';
            document.getElementById('applyDays').value = '1';

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showAlert('âœ… æœ‰çµ¦ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ï¼ˆæ®‹ã‚Š' + result.newRemaining + 'æ—¥ï¼‰', 'success');

            // ç”³è«‹å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
            reloadApplicationHistory();
          } else {
            console.error('âŒ ç”³è«‹å¤±æ•—:', result.message);
            showAlert('ç”³è«‹é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:', error);

          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          submitBtn.disabled = false;
          submitBtn.textContent = 'æœ‰çµ¦ç”³è«‹ã‚’é€ä¿¡';

          showAlert('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
        })
        .withUserObject(this)
        .submitRequest({
          userId: userId,
          applyDate: applyDate,
          applyDays: applyDays
        });
    });
    
    // ç”³è«‹å–æ¶ˆå‡¦ç†
    function cancelApplication(rowNumber, applyDate) {
      if (!confirm('ç”³è«‹æ—¥: ' + applyDate + '\nã“ã®ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      showAlert('å–æ¶ˆå‡¦ç†ä¸­...', 'warning');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // æ®‹æ—¥æ•°ã‚’æ›´æ–°
            remainingDays = result.newRemaining;
            updateRemainingDaysDisplay(result.newRemaining);

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showAlert('âœ… ' + result.message, 'success');

            // ç”³è«‹å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
            reloadApplicationHistory();
          } else {
            showAlert('å–æ¶ˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showAlert('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
        })
        .cancelUserApplication({
          userId: userId,
          rowNumber: rowNumber
        });
    }
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºé–¢æ•°
    function showAlert(message, type) {
      // æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
      var existingAlert = document.querySelector('.alert');
      if (existingAlert) {
        existingAlert.remove();
      }
      
      var alertDiv = document.createElement('div');
      alertDiv.className = 'alert ' + (type || 'info');
      alertDiv.textContent = message;
      
      var content = document.querySelector('.content');
      content.insertBefore(alertDiv, content.firstChild);
      
      // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
      setTimeout(function() {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }
    
    // æ®‹æ—¥æ•°è¡¨ç¤ºã‚’æ›´æ–°
    function updateRemainingDaysDisplay(newRemaining) {
      var remainingDaysElement = document.querySelector('.remaining-days');
      if (remainingDaysElement) {
        remainingDaysElement.innerHTML = newRemaining + '<small>æ—¥</small>';
      }
    }

    // ç”³è«‹å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
    function reloadApplicationHistory() {
      console.log('ğŸ“‹ ç”³è«‹å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿ä¸­...');

      google.script.run
        .withSuccessHandler(function(applications) {
          console.log('âœ… ç”³è«‹å±¥æ­´å–å¾—å®Œäº†:', applications);
          updateApplicationTable(applications);
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ç”³è«‹å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          showAlert('ç”³è«‹å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
        })
        .getUserApplications(userId);
    }

    // ç”³è«‹å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
    function updateApplicationTable(applications) {
      var container = document.getElementById('applicationHistoryContainer');

      if (!container) {
        console.error('ç”³è«‹å±¥æ­´ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      var newContent = '';

      if (applications && applications.length > 0) {
        newContent += '<table class="applications-table">';
        newContent += '<thead><tr>';
        newContent += '<th>ç”³è«‹æ—¥</th><th>æ—¥æ•°</th><th>ç”³è«‹æ—¥æ™‚</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ“ä½œ</th>';
        newContent += '</tr></thead><tbody>';

        applications.forEach(function(app) {
          newContent += '<tr>';
          newContent += '<td>' + app.applyDate + '</td>';
          newContent += '<td>' + (app.applyDays === 0.5 ? '0.5æ—¥' : '1æ—¥') + '</td>';
          newContent += '<td>' + app.timestamp + '</td>';
          newContent += '<td>';

          var statusClass = app.status.toLowerCase();
          var statusText = app.status === 'Pending' ? 'æ‰¿èªå¾…ã¡' :
                          app.status === 'Approved' ? 'æ‰¿èªæ¸ˆã¿' :
                          app.status === 'Rejected' ? 'å´ä¸‹' : app.status;

          newContent += '<span class="status ' + statusClass + '">' + statusText + '</span>';
          newContent += '</td>';
          newContent += '<td>';

          if (app.canCancel && app.status === 'Pending') {
            newContent += '<button class="cancel-btn" onclick="cancelApplication(' + app.rowNumber + ', \'' + app.applyDate + '\')">å–æ¶ˆ</button>';
          } else {
            newContent += '<span style="color: #999;">-</span>';
          }

          newContent += '</td></tr>';
        });

        newContent += '</tbody></table>';
      } else {
        newContent += '<div class="no-applications">ã¾ã ç”³è«‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }

      container.innerHTML = newContent;
      console.log('âœ… ç”³è«‹å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°å®Œäº†');
    }
  </script>
</body>
</html>