

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <style>
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #employeeTable {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #employeeTable th {
      background-color: #4CAF50;
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: bold;
      border: 1px solid #4CAF50;
      position: sticky;
      top: 0;
    }
    
    #employeeTable td {
      padding: 10px 8px;
      border: 1px solid #ddd;
    }
    
    #employeeTable tbody tr:hover {
      background-color: #f5f5f5;
    }
    
    #employeeTable tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    /* æ®‹æ—¥æ•°ã®å¼·èª¿è¡¨ç¤º */
    .remaining-days {
      font-weight: bold;
      font-size: 16px;
    }
    
    .remaining-low {
      color: #ff9800;
    }
    
    .remaining-critical {
      color: #f44336;
    }
    
    /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #employeeTable button {
      padding: 6px 12px;
      margin: 0 2px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      background-color: #2196F3;
      color: white;
    }
    
    #employeeTable button:hover {
      background-color: #1976D2;
    }
    
    #employeeTable button.remarks-btn {
      background-color: #FF9800;
    }
    
    #employeeTable button.remarks-btn:hover {
      background-color: #F57C00;
    }
    
    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éƒ¨åˆ†ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .controls {
      margin: 20px 0;
      padding: 15px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .controls input {
      padding: 10px;
      width: 300px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 14px;
    }
    
    .controls input:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .controls select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 14px;
    }
    
    /* çµ±è¨ˆæƒ…å ± */
    .stats {
      margin: 20px 0;
      padding: 15px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 30px;
    }
    
    .stat-item {
      flex: 1;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .stat-label {
      color: #666;
      font-size: 14px;
    }
    
    /* è¡Œç•ªå·åˆ—ã‚’éè¡¨ç¤º */
    #employeeTable th:first-child,
    #employeeTable td:first-child {
      display: none;
    }
    
    /* å‚™è€ƒæ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .remarks-cell {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .remarks-cell:hover {
      white-space: normal;
      overflow: visible;
    }
    
    /* ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
    .tabs {
      margin: 20px 0;
      border-bottom: 2px solid #4CAF50;
    }
    
    .tab-button {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-bottom: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;
    }
    
    .tab-button.active {
      background-color: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    
    .tab-content {
      display: none;
      margin-top: 20px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ç”³è«‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    #applicationTable {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #applicationTable th {
      background-color: #4CAF50;
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: bold;
      border: 1px solid #4CAF50;
    }
    
    #applicationTable td {
      padding: 10px 8px;
      border: 1px solid #ddd;
    }
    
    #applicationTable tbody tr:hover {
      background-color: #f5f5f5;
    }
    
    .approve-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 5px;
    }
    
    .approve-btn:hover {
      background-color: #45a049;
    }
    
    .reject-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .reject-btn:hover {
      background-color: #da190b;
    }
    
    .status-pending {
      color: #ff9800;
      font-weight: bold;
    }
    
    .status-approved {
      color: #4CAF50;
      font-weight: bold;
    }
  </style>
  <title>åˆ©ç”¨è€…ä¸€è¦§</title>
</head>
<body>
  <h1>ç®¡ç†ç”»é¢</h1>
  
  <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
  <div class="tabs">
    <button class="tab-button active" onclick="showTab('employees')">åˆ©ç”¨è€…ä¸€è¦§</button>
    <button class="tab-button" onclick="showTab('applications')">ç”³è«‹æ‰¿èª</button>
    <button class="tab-button" onclick="showTab('url-management')">URLç®¡ç†</button>
    <button class="tab-button" onclick="showTab('grant-management')">ä»˜ä¸ç®¡ç†</button>
    <button class="tab-button" onclick="showTab('expiry-management')">å¤±åŠ¹ç®¡ç†</button>
    <button class="tab-button" onclick="showTab('statistics')">çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ</button>
    <button class="tab-button" onclick="showTab('system-settings')">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</button>
  </div>
  
  <!-- åˆ©ç”¨è€…ä¸€è¦§ã‚¿ãƒ– -->
  <div id="employeesTab" class="tab-content active">
    <h2>åˆ©ç”¨è€…ä¸€è¦§</h2>
    <div class="stats" id="statsContainer">
    <div class="stat-item">
      <div class="stat-value" id="totalCount">-</div>
      <div class="stat-label">ç™»éŒ²è€…æ•°</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="avgRemaining">-</div>
      <div class="stat-label">å¹³å‡æ®‹æ—¥æ•°</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="zeroCount">-</div>
      <div class="stat-label">æ®‹æ—¥æ•°ã‚¼ãƒ­</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="lowCount">-</div>
      <div class="stat-label">æ®‹æ—¥æ•°5æ—¥ä»¥ä¸‹</div>
    </div>
  </div>
  
  <div class="controls">
    <input type="text" id="searchInput" placeholder="åˆ©ç”¨è€…ç•ªå·ã€æ°åã€å‚™è€ƒã§æ¤œç´¢...">
    <select id="remainingFilter">
      <option value="">æ®‹æ—¥æ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</option>
      <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
      <option value="low">5æ—¥ä»¥ä¸‹ã®ã¿</option>
      <option value="zero">ã‚¼ãƒ­ã®ã¿</option>
    </select>
    <select id="sortBy">
      <option value="">ä¸¦ã³æ›¿ãˆ</option>
      <option value="remaining">æ®‹æ—¥æ•°é †</option>
      <option value="userName">æ°åé †</option>
    </select>
  </div>
  
  <table id="employeeTable">
    <thead>
      <tr>
        <th>è¡Œç•ªå·</th>
        <th>åˆ©ç”¨è€…ç•ªå·</th>
        <th>æ°å</th>
        <th>æœ‰çµ¦æ®‹æ—¥æ•°</th>
        <th>å‚™è€ƒ</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
  
  <!-- ç”³è«‹æ‰¿èªã‚¿ãƒ– -->
  <div id="applicationsTab" class="tab-content">
    <h2>ç”³è«‹æ‰¿èª</h2>
    
    <div class="controls">
      <input type="text" id="applicationSearch" placeholder="åˆ©ç”¨è€…åã§æ¤œç´¢...">
    </div>
    
    <table id="applicationTable">
      <thead>
        <tr>
          <th>åˆ©ç”¨è€…ç•ªå·</th>
          <th>åˆ©ç”¨è€…å</th>
          <th>æœ‰çµ¦å¸Œæœ›æ—¥</th>
          <th>æ—¥æ•°</th>
          <th>ç”³è«‹æ—¥æ™‚</th>
          <th>çŠ¶æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var allEmployees = [];
    var allApplications = [];
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    // åˆæœŸåŒ–é–¢æ•°
    function onLoad() {
      console.log('ğŸ”§ ç®¡ç†ç”»é¢ - åˆæœŸåŒ–é–‹å§‹');
      
      var searchInput = document.getElementById('searchInput');
      var remainingFilter = document.getElementById('remainingFilter');
      var sortBy = document.getElementById('sortBy');
      var applicationSearch = document.getElementById('applicationSearch');
      
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          console.log('ğŸ” æ¤œç´¢å…¥åŠ›å¤‰æ›´:', searchInput.value);
          loadEmployees();
        });
      }
      
      if (remainingFilter) {
        remainingFilter.addEventListener('change', function() {
          console.log('ğŸ¯ æ®‹æ—¥æ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´:', remainingFilter.value);
          loadEmployees();
        });
      }
      
      if (sortBy) {
        sortBy.addEventListener('change', function() {
          console.log('ğŸ”„ ä¸¦ã³æ›¿ãˆå¤‰æ›´:', sortBy.value);
          loadEmployees();
        });
      }
      
      if (applicationSearch) {
        applicationSearch.addEventListener('input', function() {
          console.log('ğŸ” ç”³è«‹æ¤œç´¢å…¥åŠ›å¤‰æ›´:', applicationSearch.value);
          displayApplications();
        });
      }
      
      console.log('ğŸ“Š åˆå›ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰é–‹å§‹...');
      loadEmployees();
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œ
    window.onload = onLoad;
    
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
    function loadEmployees() {
      console.log('ğŸ“Š åˆ©ç”¨è€…ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...');
      
      var searchInput = document.getElementById('searchInput');
      var remainingFilter = document.getElementById('remainingFilter');
      var sortBy = document.getElementById('sortBy');
      
      var filter = searchInput ? String(searchInput.value || '') : '';
      var remainingFilterValue = remainingFilter ? remainingFilter.value : '';
      var sortByValue = sortBy ? sortBy.value : '';
      
      console.log('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶:', { 
        filter: filter, 
        remainingFilter: remainingFilterValue,
        sortBy: sortByValue
      });
      
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
          console.log('ğŸ“Š å–å¾—ä»¶æ•°:', data && data.records ? data.records.length : 0);
          
          if (data && data.records) {
            allEmployees = data.records;
            renderTable(allEmployees);
            updateStats(data);
            console.log('ğŸ¯ è¡¨ç¤ºå®Œäº†');
          } else {
            console.warn('âš ï¸ ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯recordsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            allEmployees = [];
            renderTable([]);
            updateStats({ stats: { total: 0, zeroCount: 0, lowCount: 0 } });
          }
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          allEmployees = [];
          renderTable([]);
          updateStats({ stats: { total: 0, zeroCount: 0, lowCount: 0 } });
        })
        .getEmployees({ 
          filter: filter,
          remainingFilter: remainingFilterValue,
          sortBy: sortByValue
        });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–¢æ•°
    function renderTable(employees) {
      console.log('ğŸ¨ ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–‹å§‹ - ä»¶æ•°:', employees.length);
      
      var tbody = document.querySelector('#employeeTable tbody');
      if (!tbody) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ã®tbodyè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      tbody.innerHTML = '';
      
      if (!employees || employees.length === 0) {
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.colSpan = 5;  // å‚™è€ƒåˆ—ã‚’å«ã‚ã¦5åˆ—
        td.style.textAlign = 'center';
        td.style.color = '#666';
        td.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
        tr.appendChild(td);
        tbody.appendChild(tr);
        console.log('ğŸ“‹ ç©ºã®ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º');
        return;
      }
      
      employees.forEach(function(emp) {
        console.log('ğŸ“ è¡Œãƒ‡ãƒ¼ã‚¿:', emp);
        
        var tr = document.createElement('tr');
        
        // è¡Œç•ªå·ï¼ˆéè¡¨ç¤ºï¼‰
        var tdRowNum = document.createElement('td');
        tdRowNum.textContent = emp.rowNumber;
        tr.appendChild(tdRowNum);
        
        // åˆ©ç”¨è€…ç•ªå·
        var tdUserId = document.createElement('td');
        tdUserId.textContent = emp.userId;
        tr.appendChild(tdUserId);
        
        // æ°å
        var tdUserName = document.createElement('td');
        tdUserName.textContent = emp.userName;
        tr.appendChild(tdUserName);
        
        // æœ‰çµ¦æ®‹æ—¥æ•°
        var tdRemaining = document.createElement('td');
        var remainingSpan = document.createElement('span');
        remainingSpan.className = 'remaining-days';
        remainingSpan.textContent = emp.remaining + ' æ—¥';
        
        // æ®‹æ—¥æ•°ã«ã‚ˆã‚‹è‰²åˆ†ã‘
        if (emp.remaining <= 3) {
          remainingSpan.className += ' remaining-critical';
        } else if (emp.remaining <= 5) {
          remainingSpan.className += ' remaining-low';
        }
        
        tdRemaining.appendChild(remainingSpan);
        tr.appendChild(tdRemaining);
        
        // å‚™è€ƒ
        var tdRemarks = document.createElement('td');
        tdRemarks.className = 'remarks-cell';
        tdRemarks.textContent = emp.remarks || '';
        tdRemarks.title = emp.remarks || ''; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§å…¨æ–‡è¡¨ç¤º
        tr.appendChild(tdRemarks);
        
        // æ“ä½œãƒœã‚¿ãƒ³
        var tdActions = document.createElement('td');
        
        // æ®‹æ—¥æ•°ç·¨é›†ãƒœã‚¿ãƒ³
        var editBtn = document.createElement('button');
        editBtn.textContent = 'æ®‹æ—¥æ•°';
        editBtn.onclick = function() {
          editRemaining(emp.rowNumber, emp.userId, emp.userName, emp.remaining);
        };
        tdActions.appendChild(editBtn);
        
        // å‚™è€ƒç·¨é›†ãƒœã‚¿ãƒ³
        var remarksBtn = document.createElement('button');
        remarksBtn.textContent = 'å‚™è€ƒ';
        remarksBtn.className = 'remarks-btn';
        remarksBtn.onclick = function() {
          editRemarks(emp.rowNumber, emp.userId, emp.userName, emp.remarks);
        };
        tdActions.appendChild(remarksBtn);
        
        tr.appendChild(tdActions);
        
        tbody.appendChild(tr);
      });
      
      console.log('ğŸ¯ ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å®Œäº†');
    }
    
    // çµ±è¨ˆæƒ…å ±æ›´æ–°
    function updateStats(data) {
      if (data.stats) {
        document.getElementById('totalCount').textContent = data.stats.total || 0;
        document.getElementById('zeroCount').textContent = data.stats.zeroCount || 0;
        document.getElementById('lowCount').textContent = data.stats.lowCount || 0;
      }
      
      // å¹³å‡æ®‹æ—¥æ•°ã®è¨ˆç®—
      var employees = data.records || [];
      var totalRemaining = employees.reduce(function(sum, emp) {
        return sum + (parseFloat(emp.remaining) || 0);
      }, 0);
      var avgRemaining = employees.length > 0 ? (totalRemaining / employees.length).toFixed(1) : 0;
      document.getElementById('avgRemaining').textContent = avgRemaining + ' æ—¥';
    }
    
    // æ®‹æ—¥æ•°ç·¨é›†
    function editRemaining(rowNumber, userId, userName, currentRemaining) {
      console.log('âœï¸ æ®‹æ—¥æ•°ç·¨é›†é–‹å§‹ - è¡Œç•ªå·:', rowNumber, 'åˆ©ç”¨è€…:', userName);
      
      var newValue = prompt(
        'ã€' + userName + ' ã•ã‚“ã€‘\n' +
        'ç¾åœ¨ã®æœ‰çµ¦æ®‹æ—¥æ•°: ' + currentRemaining + ' æ—¥\n\n' +
        'æ–°ã—ã„æ®‹æ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',
        currentRemaining
      );
      
      if (newValue === null) {
        console.log('âŒ ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
        return;
      }
      
      var newRemaining = parseFloat(newValue);
      
      if (isNaN(newRemaining)) {
        alert('æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (newRemaining < 0) {
        alert('0ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      console.log('ğŸ“ æ–°ã—ã„æ®‹æ—¥æ•°:', newRemaining);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… æ›´æ–°æˆåŠŸ:', result);
          alert(userName + ' ã•ã‚“ã®æ®‹æ—¥æ•°ã‚’ ' + newRemaining + ' æ—¥ã«æ›´æ–°ã—ã¾ã—ãŸ');
          loadEmployees();
        })
        .withFailureHandler(function(error) {
          console.error('âŒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .updateEmployeeRemaining({
          rowNumber: rowNumber,
          newRemaining: newRemaining
        });
    }
    
    // å‚™è€ƒç·¨é›†
    function editRemarks(rowNumber, userId, userName, currentRemarks) {
      console.log('âœï¸ å‚™è€ƒç·¨é›†é–‹å§‹ - è¡Œç•ªå·:', rowNumber, 'åˆ©ç”¨è€…:', userName);
      
      var newValue = prompt(
        'ã€' + userName + ' ã•ã‚“ã€‘\n' +
        'ç¾åœ¨ã®å‚™è€ƒ: ' + (currentRemarks || 'ï¼ˆãªã—ï¼‰') + '\n\n' +
        'æ–°ã—ã„å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',
        currentRemarks || ''
      );
      
      if (newValue === null) {
        console.log('âŒ ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
        return;
      }
      
      console.log('ğŸ“ æ–°ã—ã„å‚™è€ƒ:', newValue);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… å‚™è€ƒæ›´æ–°æˆåŠŸ:', result);
          alert(userName + ' ã•ã‚“ã®å‚™è€ƒã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          loadEmployees();
        })
        .withFailureHandler(function(error) {
          console.error('âŒ å‚™è€ƒæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          alert('å‚™è€ƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .updateEmployeeRemarks({
          rowNumber: rowNumber,
          newRemarks: newValue
        });
    }
    
    // ç”³è«‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadApplications() {
      console.log('ğŸ“Š ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', result);
          // getApplicationsã¯{records: [], pagination: {}}å½¢å¼ã§è¿”ã™ã®ã§ã€recordsã‚’å–å¾—
          allApplications = (result && result.records) ? result.records : [];
          displayApplications();
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          alert('ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getApplications({});
    }
    
    // ç”³è«‹ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
    function displayApplications() {
      var tbody = document.querySelector('#applicationTable tbody');
      if (!tbody) return;
      
      var searchText = document.getElementById('applicationSearch').value.toLowerCase();
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆæ‰¿èªå¾…ã¡ã®ã¿è¡¨ç¤ºï¼‰
      var filteredApplications = allApplications.filter(function(app) {
        var matchesSearch = !searchText || app.userName.toLowerCase().includes(searchText);
        // æ‰¿èªå¾…ã¡ï¼ˆPendingï¼‰ã®ã¿è¡¨ç¤º
        return matchesSearch && app.status === 'Pending';
      });
      
      if (filteredApplications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666; padding: 20px;">è©²å½“ã™ã‚‹ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }
      
      var html = '';
      filteredApplications.forEach(function(app) {
        var daysText = (app.applyDays === 0.5) ? '0.5æ—¥' : '1æ—¥';
        html += '<tr>';
        html += '<td>' + app.userId + '</td>';
        html += '<td>' + app.userName + '</td>';
        html += '<td>' + app.applyDate + '</td>';
        html += '<td>' + daysText + '</td>';
        html += '<td>' + app.timestamp + '</td>';
        html += '<td class="status-' + app.status.toLowerCase() + '">';
        html += app.status === 'Pending' ? 'æ‰¿èªå¾…ã¡' : app.status === 'Approved' ? 'æ‰¿èªæ¸ˆã¿' : app.status;
        html += '</td>';
        html += '<td>';
        
        if (app.status === 'Pending') {
          html += '<button class="approve-btn" onclick="approveApplication(' + app.recordId + ', \'' + app.userName + '\')">æ‰¿èª</button>';
          html += '<button class="reject-btn" onclick="rejectApplication(' + app.recordId + ', \'' + app.userName + '\')">å´ä¸‹</button>';
        } else {
          html += '<span style="color: #999;">-</span>';
        }
        
        html += '</td>';
        html += '</tr>';
      });
      
      tbody.innerHTML = html;
    }
    
    // ç”³è«‹æ‰¿èª
    function approveApplication(rowNumber, userName) {
      if (!confirm(userName + ' ã•ã‚“ã®ç”³è«‹ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      console.log('âœ… ç”³è«‹æ‰¿èªé–‹å§‹:', rowNumber, userName);

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… ç”³è«‹æ‰¿èªæˆåŠŸ:', result);
          // æ‰¿èªå¾Œã¯ç”³è«‹ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆæ‰¿èªæ¸ˆã¿ã¯è‡ªå‹•çš„ã«éè¡¨ç¤ºã«ãªã‚‹ï¼‰
          loadApplications();
          // å†èª­ã¿è¾¼ã¿å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          setTimeout(function() {
            alert(userName + ' ã•ã‚“ã®ç”³è«‹ã‚’æ‰¿èªã—ã¾ã—ãŸ');
          }, 500);
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ç”³è«‹æ‰¿èªã‚¨ãƒ©ãƒ¼:', error);
          if (error.message && error.message.includes('æ—¢ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™')) {
            alert('ã“ã®ç”³è«‹ã¯æ—¢ã«ä»–ã®ç®¡ç†è€…ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚\nç”»é¢ã‚’æ›´æ–°ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
            loadApplications();
          } else {
            alert('ç”³è«‹ã®æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
        })
        .approveRecord({
          rowNumber: rowNumber,
          status: 'Approved'
        });
    }
    
    // ç”³è«‹å´ä¸‹
    function rejectApplication(rowNumber, userName) {
      if (!confirm(userName + ' ã•ã‚“ã®ç”³è«‹ã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      console.log('âŒ ç”³è«‹å´ä¸‹é–‹å§‹:', rowNumber, userName);

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… ç”³è«‹å´ä¸‹æˆåŠŸ:', result);
          // å´ä¸‹å¾Œã¯ç”³è«‹ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆå´ä¸‹æ¸ˆã¿ã¯è‡ªå‹•çš„ã«éè¡¨ç¤ºã«ãªã‚‹ï¼‰
          loadApplications();
          // å†èª­ã¿è¾¼ã¿å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          setTimeout(function() {
            alert(userName + ' ã•ã‚“ã®ç”³è«‹ã‚’å´ä¸‹ã—ã¾ã—ãŸ');
          }, 500);
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ç”³è«‹å´ä¸‹ã‚¨ãƒ©ãƒ¼:', error);
          if (error.message && error.message.includes('æ—¢ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™')) {
            alert('ã“ã®ç”³è«‹ã¯æ—¢ã«ä»–ã®ç®¡ç†è€…ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚\nç”»é¢ã‚’æ›´æ–°ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
            loadApplications();
          } else {
            alert('ç”³è«‹ã®å´ä¸‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
        })
        .approveRecord({
          rowNumber: rowNumber,
          status: 'Rejected'
        });
    }
    
    // ç”³è«‹æ‰¿èªã‚¿ãƒ–ã‚’å†è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function refreshApplicationTab() {
      // ç”³è«‹æ‰¿èªã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
      showTab('applications');
      // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
      loadApplications();
    }
  </script>
  
  <!-- URLç®¡ç†ã‚¿ãƒ– -->
  <div id="url-managementTab" class="tab-content">
    <h2>URLç®¡ç†</h2>
    
    <div class="controls">
      <div style="flex: 1;">
        <h3>å€‹äººURLç®¡ç†</h3>
        <p>åˆ©ç”¨è€…ã”ã¨ã®å°‚ç”¨ã‚¢ã‚¯ã‚»ã‚¹URLã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
      </div>
      <div>
        <button onclick="generateAllUrls()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">
          å…¨å“¡ã®URLç”Ÿæˆ
        </button>
        <button onclick="refreshUrlList()" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px;">
          ä¸€è¦§ã‚’æ›´æ–°
        </button>
      </div>
    </div>
    
    <div id="urlGenerationStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>
    
    <table id="urlTable" style="display: none;">
      <thead>
        <tr>
          <th>åˆ©ç”¨è€…ç•ªå·</th>
          <th>åˆ©ç”¨è€…å</th>
          <th>URLã‚­ãƒ¼</th>
          <th>å°‚ç”¨URL</th>
          <th>ä½œæˆæ—¥</th>
          <th>æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹</th>
          <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="urlTableBody">
      </tbody>
    </table>
    
    <div id="urlTableEmpty" style="text-align: center; color: #666; margin-top: 40px;">
      URLã‚­ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œå…¨å“¡ã®URLç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
    </div>
  </div>

  <!-- ä»˜ä¸ç®¡ç†ã‚¿ãƒ– -->
  <div id="grant-managementTab" class="tab-content">
    <h2>ä»˜ä¸ç®¡ç†</h2>

    <!-- 6ãƒ¶æœˆä»˜ä¸ç®¡ç† -->
    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3 style="color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">6ãƒ¶æœˆä»˜ä¸ç®¡ç†</h3>
      <p style="color: #666; margin: 15px 0;">å…¥ç¤¾6ãƒ¶æœˆçµŒéå¾Œã®è‡ªå‹•ä»˜ä¸å‡¦ç†ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>

      <div class="controls">
        <button onclick="checkSixMonthTargets()" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">
          å¯¾è±¡è€…ç¢ºèª
        </button>
        <button onclick="executeSixMonthGrants()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px;">
          æ‰‹å‹•å®Ÿè¡Œ
        </button>
      </div>

      <div id="sixMonthGrantStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>

      <div id="sixMonthTargetsContainer" style="display: none;">
        <h4 style="margin: 20px 0 10px 0;">å¯¾è±¡è€…ãƒªã‚¹ãƒˆ</h4>
        <div id="sixMonthTargetsList"></div>
      </div>
    </div>

    <!-- å¹´æ¬¡ä»˜ä¸ç®¡ç† -->
    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3 style="color: #FF9800; border-bottom: 2px solid #FF9800; padding-bottom: 10px;">å¹´æ¬¡ä»˜ä¸ç®¡ç†ï¼ˆ4æœˆ1æ—¥ä¸€æ‹¬å‡¦ç†ï¼‰</h3>
      <p style="color: #666; margin: 15px 0;">æ¯å¹´4æœˆ1æ—¥ã®è‡ªå‹•ä»˜ä¸å‡¦ç†ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>

      <div class="controls">
        <button onclick="checkAnnualTargets()" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">
          å¯¾è±¡è€…ç¢ºèª
        </button>
        <button onclick="executeAnnualGrants()" style="background: #FF9800; color: white; padding: 10px 20px; border: none; border-radius: 5px;">
          æ‰‹å‹•å®Ÿè¡Œ
        </button>
      </div>

      <div id="annualGrantStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>

      <div id="annualTargetsContainer" style="display: none;">
        <h4 style="margin: 20px 0 10px 0;">å¯¾è±¡è€…ãƒªã‚¹ãƒˆ</h4>
        <div id="annualTargetsList"></div>
      </div>
    </div>

    <!-- ä»˜ä¸å±¥æ­´ -->
    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3 style="color: #9C27B0; border-bottom: 2px solid #9C27B0; padding-bottom: 10px;">ä»˜ä¸å±¥æ­´</h3>
      <p style="color: #666; margin: 15px 0;">ç›´è¿‘ã®ä»˜ä¸å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>

      <div class="controls">
        <button onclick="loadGrantHistory()" style="background: #9C27B0; color: white; padding: 10px 20px; border: none; border-radius: 5px;">
          å±¥æ­´èª­ã¿è¾¼ã¿
        </button>
      </div>

      <div id="grantHistoryStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>

      <div id="grantHistoryContainer" style="display: none; margin-top: 20px;">
        <table id="grantHistoryTable" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #9C27B0; color: white;">
              <th style="padding: 10px; border: 1px solid #ddd;">ä»˜ä¸æ—¥</th>
              <th style="padding: 10px; border: 1px solid #ddd;">åˆ©ç”¨è€…ID</th>
              <th style="padding: 10px; border: 1px solid #ddd;">åˆ©ç”¨è€…å</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ä»˜ä¸æ—¥æ•°</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ä»˜ä¸ç¨®åˆ¥</th>
              <th style="padding: 10px; border: 1px solid #ddd;">å‹¤ç¶šå¹´æ•°</th>
            </tr>
          </thead>
          <tbody id="grantHistoryTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- å¤±åŠ¹ç®¡ç†ã‚¿ãƒ– -->
  <div id="expiry-managementTab" class="tab-content">
    <h2>å¤±åŠ¹ç®¡ç†</h2>

    <!-- å¤±åŠ¹äºˆå®šç¢ºèª -->
    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3 style="color: #f44336; border-bottom: 2px solid #f44336; padding-bottom: 10px;">å¤±åŠ¹äºˆå®šã®ç¢ºèª</h3>
      <p style="color: #666; margin: 15px 0;">å¤±åŠ¹äºˆå®šã®æœ‰çµ¦ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>

      <div class="controls">
        <label>ç¢ºèªæœŸé–“ï¼š</label>
        <select id="expiryCheckPeriod" style="width: 150px;">
          <option value="7">1é€±é–“ä»¥å†…</option>
          <option value="30" selected>1ãƒ¶æœˆä»¥å†…</option>
          <option value="90">3ãƒ¶æœˆä»¥å†…</option>
          <option value="180">6ãƒ¶æœˆä»¥å†…</option>
        </select>
        <button onclick="checkExpiringLeaves()" style="background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-left: 10px;">
          å¤±åŠ¹äºˆå®šç¢ºèª
        </button>
      </div>

      <div id="expiryCheckStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>

      <div id="expiringLeavesContainer" style="display: none;">
        <h4 style="margin: 20px 0 10px 0;">å¤±åŠ¹äºˆå®šãƒªã‚¹ãƒˆ</h4>
        <div id="expiringLeavesList"></div>
      </div>
    </div>

    <!-- å¤±åŠ¹å‡¦ç†å®Ÿè¡Œ -->
    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3 style="color: #FF5722; border-bottom: 2px solid #FF5722; padding-bottom: 10px;">å¤±åŠ¹å‡¦ç†ã®å®Ÿè¡Œ</h3>
      <p style="color: #666; margin: 15px 0;">å¤±åŠ¹æ—¥ã‚’éããŸæœ‰çµ¦ã‚’å‡¦ç†ã—ã¾ã™ã€‚é€šå¸¸ã¯æ¯æ—¥è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€ç·Šæ€¥æ™‚ã«æ‰‹å‹•ã§å®Ÿè¡Œã§ãã¾ã™ã€‚</p>

      <div class="controls">
        <button onclick="executeExpiryProcess()" style="background: #FF5722; color: white; padding: 10px 20px; border: none; border-radius: 5px;">
          å¤±åŠ¹å‡¦ç†å®Ÿè¡Œ
        </button>
      </div>

      <div id="expiryProcessStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>
    </div>
  </div>

  <!-- çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
  <div id="statisticsTab" class="tab-content">
    <h2>çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ</h2>

    <div style="margin: 20px 0;">
      <h3>å…¨ä½“çµ±è¨ˆ</h3>
      <div id="basicStatistics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
        <div style="padding: 15px; background: #f5f5f5; border-radius: 5px;">
          <div style="font-size: 14px; color: #666;">ç·å¾“æ¥­å“¡æ•°</div>
          <div id="totalEmployees" style="font-size: 24px; font-weight: bold; margin-top: 5px;">-</div>
        </div>
        <div style="padding: 15px; background: #f5f5f5; border-radius: 5px;">
          <div style="font-size: 14px; color: #666;">å¹³å‡æ®‹æ—¥æ•°</div>
          <div id="averageRemainingDays" style="font-size: 24px; font-weight: bold; margin-top: 5px;">-</div>
        </div>
        <div style="padding: 15px; background: #f5f5f5; border-radius: 5px;">
          <div style="font-size: 14px; color: #666;">æ®‹æ—¥æ•°5æ—¥ä»¥ä¸‹</div>
          <div id="lowRemainingCount" style="font-size: 24px; font-weight: bold; margin-top: 5px; color: #ff6b6b;">-</div>
        </div>
        <div style="padding: 15px; background: #f5f5f5; border-radius: 5px;">
          <div style="font-size: 14px; color: #666;">ç·æ®‹æ—¥æ•°</div>
          <div id="totalRemainingDays" style="font-size: 24px; font-weight: bold; margin-top: 5px;">-</div>
        </div>
      </div>
    </div>

    <div style="margin: 30px 0;">
      <h3>äº‹æ¥­æ‰€åˆ¥çµ±è¨ˆ</h3>
      <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
          <tr style="background: #4CAF50; color: white;">
            <th style="padding: 12px; text-align: left;">äº‹æ¥­æ‰€</th>
            <th style="padding: 12px; text-align: right;">å¾“æ¥­å“¡æ•°</th>
            <th style="padding: 12px; text-align: right;">å¹³å‡æ®‹æ—¥æ•°</th>
            <th style="padding: 12px; text-align: right;">ç·æ®‹æ—¥æ•°</th>
          </tr>
        </thead>
        <tbody id="divisionStatistics">
          <tr><td colspan="4" style="text-align: center; padding: 20px; color: #666;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="margin: 30px 0;">
      <button onclick="loadStatistics()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
        çµ±è¨ˆã‚’æ›´æ–°
      </button>
    </div>
  </div>

  <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¿ãƒ– -->
  <div id="system-settingsTab" class="tab-content">
    <h2>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>

    <!-- ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®š -->
    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3 style="color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®š</h3>

      <div style="background: #E8F5E9; padding: 15px; border-radius: 5px; margin: 15px 0;">
        <h4 style="margin-top: 0; color: #2E7D32;">ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè‡ªå‹•è¨­å®šæ©Ÿèƒ½</h4>
        <p style="margin: 10px 0; line-height: 1.6;">
          ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã®åˆ—æ§‹æˆã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è‡ªå‹•çš„ã«æ•´ãˆã¾ã™ã€‚<br>
          <strong>è¨­å®šã•ã‚Œã‚‹å†…å®¹ï¼š</strong>
        </p>
        <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
          <li>8åˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šï¼ˆåˆ©ç”¨è€…ç•ªå·ã€œæœ€æ–°å¹´æ¬¡ä»˜ä¸æ—¥ï¼‰</li>
          <li>åˆ—å¹…ã®è‡ªå‹•èª¿æ•´</li>
          <li>æ—¥ä»˜ãƒ»æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è¨­å®š</li>
          <li>é€±æ‰€å®šåŠ´åƒæ—¥æ•°ã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ï¼ˆ1-5ã®æ•´æ•°ï¼‰</li>
          <li>æ®‹æœ‰çµ¦æ—¥æ•°ã®æ¡ä»¶ä»˜ãæ›¸å¼ï¼ˆ0æ—¥:èµ¤ã€1-5æ—¥:ã‚ªãƒ¬ãƒ³ã‚¸ã€10æ—¥ä»¥ä¸Š:ç·‘ï¼‰</li>
          <li>ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®å›ºå®š</li>
        </ul>
        <p style="margin: 10px 0; color: #F57C00; font-weight: bold;">
          â€» æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¿ãŒå¤‰æ›´ã•ã‚Œã¾ã™ã€‚
        </p>
      </div>

      <div style="margin: 20px 0;">
        <button onclick="formatMaster()"
                style="padding: 12px 24px;
                       background: #4CAF50;
                       color: white;
                       border: none;
                       border-radius: 5px;
                       font-size: 16px;
                       font-weight: bold;
                       cursor: pointer;
                       box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
          ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨­å®š
        </button>
      </div>

      <div id="formatMasterStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>
    </div>

    <!-- ãƒãƒ‹ãƒ¥ã‚¢ãƒ«è¿½åŠ  -->
    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3 style="color: #2196F3; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">ã‚·ãƒ¼ãƒˆæ“ä½œãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h3>

      <div style="background: #E3F2FD; padding: 15px; border-radius: 5px; margin: 15px 0;">
        <h4 style="margin-top: 0; color: #1565C0;">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«è¿½åŠ æ©Ÿèƒ½</h4>
        <p style="margin: 10px 0; line-height: 1.6;">
          ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã¨ä»˜ä¸å±¥æ­´ã‚·ãƒ¼ãƒˆã®ç©ºãåˆ—ï¼ˆJåˆ—ä»¥é™ï¼‰ã«ã€ä½¿ã„æ–¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚<br>
          <strong>å«ã¾ã‚Œã‚‹å†…å®¹ï¼š</strong>
        </p>
        <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
          <li>å„åˆ—ã®èª¬æ˜</li>
          <li>æ‰‹å‹•ä¿®æ­£ã®æ‰‹é †ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ï¼‰</li>
          <li>ãƒ‡ãƒ¼ã‚¿ã®è¦‹æ–¹ï¼ˆæœ‰åŠ¹/å¤±åŠ¹/æ¶ˆè²»æ¸ˆã¿ï¼‰</li>
          <li>FIFOæ–¹å¼ã®èª¬æ˜</li>
          <li>è‡ªå‹•å‡¦ç†ã¨ã®é€£æº</li>
          <li>æ³¨æ„äº‹é …</li>
        </ul>
        <p style="margin: 10px 0; color: #F57C00; font-weight: bold;">
          â€» ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ä½•åº¦ã§ã‚‚å®Ÿè¡Œã§ãã¾ã™ã€‚æ—¢å­˜ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
        </p>
      </div>

      <div style="margin: 20px 0;">
        <button onclick="addManuals()"
                style="padding: 12px 24px;
                       background: #2196F3;
                       color: white;
                       border: none;
                       border-radius: 5px;
                       font-size: 16px;
                       font-weight: bold;
                       cursor: pointer;
                       box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
          ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’è¿½åŠ 
        </button>
      </div>

      <div id="manualAddStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ -->
    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3 style="color: #FF9800; border-bottom: 2px solid #FF9800; padding-bottom: 10px;">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</h3>

      <div style="background: #FFF3E0; padding: 15px; border-radius: 5px; margin: 15px 0;">
        <h4 style="margin-top: 0; color: #E65100;">ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ç”Ÿæˆ</h4>
        <p style="margin: 10px 0; line-height: 1.6;">
          ä»˜ä¸ç®¡ç†ãƒ»å¤±åŠ¹ç®¡ç†æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚<br>
          <strong>ç”Ÿæˆã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ï¼š</strong>
        </p>
        <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
          <li><strong>ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼6å</strong>
            <ul style="margin: 5px 0 5px 20px;">
              <li>TEST01, TEST02: 6ãƒ¶æœˆä»˜ä¸å¯¾è±¡è€…</li>
              <li>TEST03: å¹´æ¬¡ä»˜ä¸å¯¾è±¡è€…</li>
              <li>TEST04: å¤±åŠ¹é–“è¿‘ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š</li>
              <li>TEST05: å¤±åŠ¹æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š</li>
              <li>TEST06: FIFOç¢ºèªç”¨ï¼ˆè¤‡æ•°ä»˜ä¸å±¥æ­´ï¼‰</li>
            </ul>
          </li>
          <li><strong>ä»˜ä¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿</strong>ï¼ˆç´„15ä»¶ï¼‰
            <ul style="margin: 5px 0 5px 20px;">
              <li>5æ—¥å¾Œã€1é€±é–“å¾Œã€1ãƒ¶æœˆå¾Œã€3ãƒ¶æœˆå¾Œã«å¤±åŠ¹äºˆå®š</li>
              <li>ã™ã§ã«å¤±åŠ¹æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿</li>
              <li>FIFOæ–¹å¼ã®ç¢ºèªç”¨ã«è¤‡æ•°å›ã®ä»˜ä¸</li>
            </ul>
          </li>
        </ul>
        <p style="margin: 10px 0; color: #D84315; font-weight: bold;">
          âš  ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã¨ä»˜ä¸å±¥æ­´ã‚·ãƒ¼ãƒˆã«å®Ÿéš›ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚
        </p>
      </div>

      <div style="margin: 20px 0;">
        <button onclick="generateTest()"
                style="padding: 12px 24px;
                       background: #FF9800;
                       color: white;
                       border: none;
                       border-radius: 5px;
                       font-size: 16px;
                       font-weight: bold;
                       cursor: pointer;
                       box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
          ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        </button>
      </div>

      <div id="generateTestStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>
    </div>

    <!-- ãã®ä»–ã®ã‚·ã‚¹ãƒ†ãƒ è¨­å®š -->
    <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3 style="color: #666; border-bottom: 2px solid #999; padding-bottom: 10px;">ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>

      <div style="margin: 15px 0;">
        <table style="width: 100%; border-collapse: collapse;">
          <tr style="border-bottom: 1px solid #ddd;">
            <td style="padding: 10px; font-weight: bold; width: 200px;">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</td>
            <td style="padding: 10px;">1.0.0</td>
          </tr>
          <tr style="border-bottom: 1px solid #ddd;">
            <td style="padding: 10px; font-weight: bold;">æœ€çµ‚æ›´æ–°</td>
            <td style="padding: 10px;">2025-11-08</td>
          </tr>
          <tr style="border-bottom: 1px solid #ddd;">
            <td style="padding: 10px; font-weight: bold;">è‡ªå‹•å‡¦ç†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</td>
            <td style="padding: 10px;">
              â€¢ æ¯æ—¥9æ™‚: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯<br>
              â€¢ æ¯æ—¥9æ™‚30åˆ†: å¤±åŠ¹å‡¦ç†<br>
              â€¢ æ¯æ—¥10æ™‚: 6ãƒ¶æœˆä»˜ä¸ãƒã‚§ãƒƒã‚¯<br>
              â€¢ æ¯å¹´4æœˆ1æ—¥8æ™‚: å¹´æ¬¡ä»˜ä¸å‡¦ç†
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <script>
    // URLç®¡ç†æ©Ÿèƒ½ã®JavaScript
    
    function generateAllUrls() {
      var statusDiv = document.getElementById('urlGenerationStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> å…¨åˆ©ç”¨è€…ã®URLã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('URLç”Ÿæˆçµæœ:', result);
          
          if (result.success) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '<strong>å®Œäº†!</strong> ' + result.message;
            
            // çµæœã‚’è¡¨ç¤º
            displayUrlResults(result.results);
            refreshUrlList();
          } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.border = '1px solid #f5c6cb';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + result.message;
          }
        })
        .withFailureHandler(function(error) {
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .generateAllUserUrls();
    }
    
    function refreshUrlList() {
      // URLä¸€è¦§ã‚’å–å¾—ã™ã‚‹æ©Ÿèƒ½ï¼ˆå®Ÿè£…ãŒå¿…è¦ï¼‰
      console.log('URLä¸€è¦§ã®æ›´æ–°');
      // ã“ã®æ©Ÿèƒ½ã¯æ¬¡ã®å®Ÿè£…ã§è¿½åŠ äºˆå®š
    }
    
    function displayUrlResults(results) {
      var table = document.getElementById('urlTable');
      var tbody = document.getElementById('urlTableBody');
      var emptyDiv = document.getElementById('urlTableEmpty');
      
      if (results && results.length > 0) {
        tbody.innerHTML = '';
        
        results.forEach(function(item) {
          var row = tbody.insertRow();
          
          if (item.success) {
            var truncatedKey = item.urlKey.substring(0, 8) + '...';
            var shortUrl = item.url.substring(0, 50) + '...';
            
            row.innerHTML = `
              <td>${item.userId}</td>
              <td>${item.userName}</td>
              <td title="${item.urlKey}">${truncatedKey}</td>
              <td>
                <a href="${item.url}" target="_blank" title="${item.url}">${shortUrl}</a>
              </td>
              <td>æ–°è¦ä½œæˆ</td>
              <td>-</td>
              <td style="color: #4CAF50; font-weight: bold;">active</td>
              <td>
                <button onclick="copyUrl('${item.url}')" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 5px;">
                  URLã‚³ãƒ”ãƒ¼
                </button>
                <button onclick="deactivateUrl('${item.userId}')" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px;">
                  ç„¡åŠ¹åŒ–
                </button>
              </td>
            `;
          } else {
            row.innerHTML = `
              <td>${item.userId}</td>
              <td>${item.userName}</td>
              <td colspan="4" style="color: #f44336;">ã‚¨ãƒ©ãƒ¼: ${item.error}</td>
              <td style="color: #f44336;">failed</td>
              <td>-</td>
            `;
          }
        });
        
        table.style.display = 'table';
        emptyDiv.style.display = 'none';
      } else {
        table.style.display = 'none';
        emptyDiv.style.display = 'block';
      }
    }
    
    function copyUrl(url) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(function() {
          alert('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }).catch(function(err) {
          console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
          fallbackCopyUrl(url);
        });
      } else {
        fallbackCopyUrl(url);
      }
    }
    
    function fallbackCopyUrl(url) {
      var textArea = document.createElement("textarea");
      textArea.value = url;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      textArea.style.top = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        alert('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      } catch (err) {
        prompt('ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url);
      }
      
      document.body.removeChild(textArea);
    }
    
    function deactivateUrl(userId) {
      if (!confirm('åˆ©ç”¨è€… ' + userId + ' ã®URLã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ\nç„¡åŠ¹åŒ–å¾Œã¯è©²å½“URLã§ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚')) {
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result) {
            alert('URLã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ');
            refreshUrlList();
          } else {
            alert('URLã‚­ãƒ¼ã®ç„¡åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          alert('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .deactivateUserUrl(userId);
    }

    // =============================
    // ä»˜ä¸ç®¡ç†æ©Ÿèƒ½ã®JavaScript
    // =============================

    function checkSixMonthTargets() {
      var statusDiv = document.getElementById('sixMonthGrantStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> 6ãƒ¶æœˆä»˜ä¸å¯¾è±¡è€…ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚';

      document.getElementById('sixMonthTargetsContainer').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(targets) {
          console.log('6ãƒ¶æœˆä»˜ä¸å¯¾è±¡è€…:', targets);

          if (targets && targets.length > 0) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '<strong>å®Œäº†!</strong> ' + targets.length + 'åã®å¯¾è±¡è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚';

            displaySixMonthTargets(targets);
          } else {
            statusDiv.style.background = '#d1ecf1';
            statusDiv.style.border = '1px solid #bee5eb';
            statusDiv.style.color = '#0c5460';
            statusDiv.innerHTML = '<strong>å¯¾è±¡è€…ãªã—</strong> ç¾åœ¨6ãƒ¶æœˆä»˜ä¸ã®å¯¾è±¡è€…ã¯ã„ã¾ã›ã‚“ã€‚';
          }
        })
        .withFailureHandler(function(error) {
          console.error('6ãƒ¶æœˆä»˜ä¸å¯¾è±¡è€…ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .getSixMonthGrantTargets();
    }

    function displaySixMonthTargets(targets) {
      var container = document.getElementById('sixMonthTargetsContainer');
      container.style.display = 'block';

      var html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
      html += '<thead><tr style="background: #4CAF50; color: white;">';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">åˆ©ç”¨è€…ID</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">åˆ©ç”¨è€…å</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">å…¥ç¤¾æ—¥</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">çµŒéæ—¥æ•°</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">ä»˜ä¸æ—¥æ•°</th>';
      html += '</tr></thead><tbody>';

      targets.forEach(function(target) {
        html += '<tr style="background: white;">';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (target.userId || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (target.userName || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (target.hireDate || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (target.daysFromHire || '-') + 'æ—¥</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; color: #4CAF50;">' + (target.grantDays || '-') + 'æ—¥</td>';
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('sixMonthTargetsList').innerHTML = html;
    }

    function executeSixMonthGrants() {
      if (!confirm('6ãƒ¶æœˆä»˜ä¸å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡è€…å…¨å“¡ã«æœ‰çµ¦ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      var statusDiv = document.getElementById('sixMonthGrantStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> 6ãƒ¶æœˆä»˜ä¸å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('6ãƒ¶æœˆä»˜ä¸å®Ÿè¡Œçµæœ:', result);

          if (result.success) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '<strong>å®Œäº†!</strong> ' + result.message;

            // å¯¾è±¡è€…ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
            setTimeout(function() {
              checkSixMonthTargets();
            }, 2000);
          } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.border = '1px solid #f5c6cb';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + result.message;
          }
        })
        .withFailureHandler(function(error) {
          console.error('6ãƒ¶æœˆä»˜ä¸å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .processSixMonthGrants();
    }

    function checkAnnualTargets() {
      var statusDiv = document.getElementById('annualGrantStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> å¹´æ¬¡ä»˜ä¸å¯¾è±¡è€…ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚';

      document.getElementById('annualTargetsContainer').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(targets) {
          console.log('å¹´æ¬¡ä»˜ä¸å¯¾è±¡è€…:', targets);

          if (targets && targets.length > 0) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '<strong>å®Œäº†!</strong> ' + targets.length + 'åã®å¯¾è±¡è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚';

            displayAnnualTargets(targets);
          } else {
            statusDiv.style.background = '#d1ecf1';
            statusDiv.style.border = '1px solid #bee5eb';
            statusDiv.style.color = '#0c5460';
            statusDiv.innerHTML = '<strong>å¯¾è±¡è€…ãªã—</strong> ç¾åœ¨å¹´æ¬¡ä»˜ä¸ã®å¯¾è±¡è€…ã¯ã„ã¾ã›ã‚“ã€‚';
          }
        })
        .withFailureHandler(function(error) {
          console.error('å¹´æ¬¡ä»˜ä¸å¯¾è±¡è€…ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .getAnnualGrantTargets();
    }

    function displayAnnualTargets(targets) {
      var container = document.getElementById('annualTargetsContainer');
      container.style.display = 'block';

      var html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
      html += '<thead><tr style="background: #FF9800; color: white;">';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">åˆ©ç”¨è€…ID</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">åˆ©ç”¨è€…å</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">å…¥ç¤¾æ—¥</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">å‹¤ç¶šå¹´æ•°</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">ä»˜ä¸æ—¥æ•°</th>';
      html += '</tr></thead><tbody>';

      targets.forEach(function(target) {
        html += '<tr style="background: white;">';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (target.userId || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (target.userName || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (target.hireDate || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (target.workYears || '-') + 'å¹´</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; color: #FF9800;">' + (target.grantDays || '-') + 'æ—¥</td>';
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('annualTargetsList').innerHTML = html;
    }

    function executeAnnualGrants() {
      if (!confirm('å¹´æ¬¡ä»˜ä¸å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡è€…å…¨å“¡ã«æœ‰çµ¦ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      var statusDiv = document.getElementById('annualGrantStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> å¹´æ¬¡ä»˜ä¸å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('å¹´æ¬¡ä»˜ä¸å®Ÿè¡Œçµæœ:', result);

          if (result.success) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '<strong>å®Œäº†!</strong> ' + result.message;

            // å¯¾è±¡è€…ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
            setTimeout(function() {
              checkAnnualTargets();
            }, 2000);
          } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.border = '1px solid #f5c6cb';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + result.message;
          }
        })
        .withFailureHandler(function(error) {
          console.error('å¹´æ¬¡ä»˜ä¸å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .processAnnualGrants();
    }

    function loadGrantHistory() {
      var statusDiv = document.getElementById('grantHistoryStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> ä»˜ä¸å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚';

      document.getElementById('grantHistoryContainer').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(history) {
          console.log('ä»˜ä¸å±¥æ­´:', history);

          if (history && history.length > 0) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '<strong>å®Œäº†!</strong> ' + history.length + 'ä»¶ã®å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚';

            displayGrantHistory(history);
          } else {
            statusDiv.style.background = '#d1ecf1';
            statusDiv.style.border = '1px solid #bee5eb';
            statusDiv.style.color = '#0c5460';
            statusDiv.innerHTML = '<strong>å±¥æ­´ãªã—</strong> ä»˜ä¸å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
          }
        })
        .withFailureHandler(function(error) {
          console.error('ä»˜ä¸å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .getRecentGrantHistory();
    }

    function displayGrantHistory(history) {
      var container = document.getElementById('grantHistoryContainer');
      container.style.display = 'block';

      var tbody = document.getElementById('grantHistoryTableBody');
      tbody.innerHTML = '';

      history.forEach(function(record) {
        var row = tbody.insertRow();
        row.style.background = 'white';

        row.insertCell(0).textContent = record.grantDate || '-';
        row.insertCell(1).textContent = record.userId || '-';
        row.insertCell(2).textContent = record.userName || '-';
        row.insertCell(3).textContent = (record.grantDays || 0) + 'æ—¥';
        row.insertCell(4).textContent = record.grantType || '-';
        row.insertCell(5).textContent = (record.workYears || '-') + 'å¹´';

        // ã‚»ãƒ«ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
        for (var i = 0; i < row.cells.length; i++) {
          row.cells[i].style.padding = '10px';
          row.cells[i].style.border = '1px solid #ddd';
        }
      });
    }

    // =============================
    // å¤±åŠ¹ç®¡ç†æ©Ÿèƒ½ã®JavaScript
    // =============================

    function checkExpiringLeaves() {
      var days = parseInt(document.getElementById('expiryCheckPeriod').value);

      var statusDiv = document.getElementById('expiryCheckStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> å¤±åŠ¹äºˆå®šã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚';

      document.getElementById('expiringLeavesContainer').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('å¤±åŠ¹äºˆå®šç¢ºèªçµæœ:', result);

          if (result && result.length > 0) {
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.border = '1px solid #ffc107';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = '<strong>è­¦å‘Š!</strong> ' + result.length + 'ä»¶ã®å¤±åŠ¹äºˆå®šãŒã‚ã‚Šã¾ã™ã€‚';

            displayExpiringLeaves(result);
          } else {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '<strong>è‰¯å¥½</strong> å¤±åŠ¹äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
          }
        })
        .withFailureHandler(function(error) {
          console.error('å¤±åŠ¹äºˆå®šç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .getExpiringLeaves(days);
    }

    function displayExpiringLeaves(leaves) {
      var container = document.getElementById('expiringLeavesContainer');
      container.style.display = 'block';

      var html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
      html += '<thead><tr style="background: #f44336; color: white;">';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">åˆ©ç”¨è€…ID</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">åˆ©ç”¨è€…å</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">ä»˜ä¸æ—¥</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">å¤±åŠ¹æ—¥</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">æ®‹æ—¥æ•°</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">æ®‹ã‚Šæ—¥æ•°</th>';
      html += '</tr></thead><tbody>';

      leaves.forEach(function(leave) {
        var daysUntilExpiry = Math.ceil((new Date(leave.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
        var urgencyColor = daysUntilExpiry <= 7 ? '#f44336' : (daysUntilExpiry <= 30 ? '#FF9800' : '#FFC107');

        html += '<tr style="background: white;">';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (leave.userId || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (leave.userName || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (leave.grantDate || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (leave.expiryDate || '-') + '</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">' + (leave.remainingDays || 0) + 'æ—¥</td>';
        html += '<td style="padding: 10px; border: 1px solid #ddd; color: ' + urgencyColor + '; font-weight: bold;">' + daysUntilExpiry + 'æ—¥å¾Œ</td>';
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('expiringLeavesList').innerHTML = html;
    }

    function executeExpiryProcess() {
      if (!confirm('å¤±åŠ¹å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nå¤±åŠ¹æ—¥ã‚’éããŸæœ‰çµ¦ãŒå¤±åŠ¹ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }

      var statusDiv = document.getElementById('expiryProcessStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> å¤±åŠ¹å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('å¤±åŠ¹å‡¦ç†å®Ÿè¡Œçµæœ:', result);

          if (result.success) {
            if (result.expiredCount > 0) {
              statusDiv.style.background = '#fff3cd';
              statusDiv.style.border = '1px solid #ffc107';
              statusDiv.style.color = '#856404';
              statusDiv.innerHTML = '<strong>å®Œäº†!</strong> ' + result.message;
            } else {
              statusDiv.style.background = '#d4edda';
              statusDiv.style.border = '1px solid #c3e6cb';
              statusDiv.style.color = '#155724';
              statusDiv.innerHTML = '<strong>å®Œäº†!</strong> å¤±åŠ¹å¯¾è±¡ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
            }

            // å¤±åŠ¹äºˆå®šã‚’å†ç¢ºèª
            setTimeout(function() {
              checkExpiringLeaves();
            }, 2000);
          } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.border = '1px solid #f5c6cb';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + result.message;
          }
        })
        .withFailureHandler(function(error) {
          console.error('å¤±åŠ¹å‡¦ç†å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .processExpiredLeaves();
    }

    // =============================
    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šæ©Ÿèƒ½ã®JavaScript
    // =============================

    function formatMaster() {
      if (!confirm('ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™ã‹ï¼Ÿ\n\nåˆ—æ§‹æˆã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãªã©ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      var statusDiv = document.getElementById('formatMasterStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®šçµæœ:', result);

          if (result.success) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';

            var detailHtml = '<strong>å®Œäº†!</strong> ' + result.message + '<br><br>';
            detailHtml += '<div style="margin-top: 10px; padding: 10px; background: #E8F5E9; border-radius: 3px;">';
            detailHtml += '<strong>è¨­å®šå†…å®¹:</strong><ul style="margin: 10px 0;">';
            detailHtml += '<li>åˆ—æ•°: ' + result.details.columns + 'åˆ—</li>';
            detailHtml += '<li>ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¡Œæ•°: ' + result.details.formattedRows + 'è¡Œ</li>';
            detailHtml += '<li>ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼: ' + result.details.validations + '</li>';
            detailHtml += '<li>æ¡ä»¶ä»˜ãæ›¸å¼: ' + result.details.conditionalFormats + '</li>';
            detailHtml += '</ul></div>';
            detailHtml += '<p style="margin-top: 10px; color: #2E7D32;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';

            statusDiv.innerHTML = detailHtml;
          } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.border = '1px solid #f5c6cb';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + result.message;
          }
        })
        .withFailureHandler(function(error) {
          console.error('ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .formatMasterSheet();
    }

    function addManuals() {
      if (!confirm('ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã¨ä»˜ä¸å±¥æ­´ã‚·ãƒ¼ãƒˆã«ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\n\næ—¢å­˜ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      var statusDiv = document.getElementById('manualAddStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('ãƒãƒ‹ãƒ¥ã‚¢ãƒ«è¿½åŠ çµæœ:', result);

          if (result.success) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';

            var detailHtml = '<strong>å®Œäº†!</strong> ' + result.message + '<br><br>';
            detailHtml += '<div style="margin-top: 10px; padding: 10px; background: #E8F5E9; border-radius: 3px;">';
            detailHtml += '<strong>è¿½åŠ ã•ã‚ŒãŸãƒãƒ‹ãƒ¥ã‚¢ãƒ«:</strong><ul style="margin: 10px 0;">';

            result.results.forEach(function(item) {
              if (item.success) {
                detailHtml += '<li>' + item.sheet + 'ã‚·ãƒ¼ãƒˆ: å®Œäº†</li>';
              } else {
                detailHtml += '<li>' + item.sheet + 'ã‚·ãƒ¼ãƒˆ: å¤±æ•— (' + (item.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼') + ')</li>';
              }
            });

            detailHtml += '</ul></div>';
            detailHtml += '<p style="margin-top: 10px; color: #1976D2;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®Jåˆ—ä»¥é™ã§ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>';

            statusDiv.innerHTML = detailHtml;
          } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.border = '1px solid #f5c6cb';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + result.message;
          }
        })
        .withFailureHandler(function(error) {
          console.error('ãƒãƒ‹ãƒ¥ã‚¢ãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .addSheetManuals();
    }

    function generateTest() {
      if (!confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\n\n6åã®ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ç´„15ä»¶ã®ä»˜ä¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã¨ä»˜ä¸å±¥æ­´ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      var statusDiv = document.getElementById('generateTestStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆçµæœ:', result);

          if (result.success) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';

            var detailHtml = '<strong>å®Œäº†!</strong> ' + result.message + '<br><br>';
            detailHtml += '<div style="margin-top: 10px; padding: 10px; background: #E8F5E9; border-radius: 3px;">';
            detailHtml += '<strong>ç”Ÿæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:</strong><ul style="margin: 10px 0;">';
            detailHtml += '<li>ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼: ' + result.details.masterUsers + 'å</li>';
            detailHtml += '<li>ä»˜ä¸å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰: ' + result.details.grantRecords + 'ä»¶</li>';
            detailHtml += '</ul>';

            if (result.details.scenarios && result.details.scenarios.length > 0) {
              detailHtml += '<strong>ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª:</strong><ul style="margin: 10px 0;">';
              result.details.scenarios.forEach(function(scenario) {
                detailHtml += '<li>' + scenario + '</li>';
              });
              detailHtml += '</ul>';
            }

            detailHtml += '</div>';
            detailHtml += '<p style="margin-top: 10px; color: #E65100;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
            detailHtml += '<p style="margin-top: 5px; color: #1976D2;">ã€Œä»˜ä¸ç®¡ç†ã€ã‚¿ãƒ–ã¨ã€Œå¤±åŠ¹ç®¡ç†ã€ã‚¿ãƒ–ã§æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚</p>';

            statusDiv.innerHTML = detailHtml;
          } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.border = '1px solid #f5c6cb';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + result.message;
          }
        })
        .withFailureHandler(function(error) {
          console.error('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .generateTestData();
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’æ‹¡å¼µ
    function showTab(tabName) {
      // æ—¢å­˜ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
      var tabs = document.querySelectorAll('.tab-content');
      var buttons = document.querySelectorAll('.tab-button');

      tabs.forEach(function(tab) {
        tab.classList.remove('active');
      });

      buttons.forEach(function(button) {
        button.classList.remove('active');
      });

      var targetTab = document.getElementById(tabName + 'Tab');
      if (targetTab) {
        targetTab.classList.add('active');
      }

      event.target.classList.add('active');

      // ç”³è«‹ç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
      if (tabName === 'applications') {
        console.log('ğŸ“‹ ç”³è«‹ç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        loadApplications(); // ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
      }

      // URLç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®åˆæœŸåŒ–
      if (tabName === 'url-management') {
        console.log('URLç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        // å¿…è¦ã«å¿œã˜ã¦åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
      }

      // ä»˜ä¸ç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®åˆæœŸåŒ–
      if (tabName === 'grant-management') {
        console.log('ğŸ ä»˜ä¸ç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        // å¿…è¦ã«å¿œã˜ã¦åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
      }

      // çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®åˆæœŸåŒ–
      if (tabName === 'statistics') {
        console.log('ğŸ“Š çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ–ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        loadStatistics();
      }

      // å¤±åŠ¹ç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®åˆæœŸåŒ–
      if (tabName === 'expiry-management') {
        console.log('â³ å¤±åŠ¹ç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        // å¿…è¦ã«å¿œã˜ã¦åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
      }
    }

    // =============================
    // çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®JavaScript
    // =============================

    function loadStatistics() {
      console.log('ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');

      google.script.run
        .withSuccessHandler(function(stats) {
          console.log('âœ… çµ±è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', stats);
          displayBasicStatistics(stats);
        })
        .withFailureHandler(function(error) {
          console.error('âŒ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          alert('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .calculateBasicStatistics();
    }

    function displayBasicStatistics(stats) {
      // å…¨ä½“çµ±è¨ˆã®è¡¨ç¤º
      document.getElementById('totalEmployees').textContent = stats.totalEmployees || 0;
      document.getElementById('averageRemainingDays').textContent =
        stats.averageRemainingDays ? stats.averageRemainingDays.toFixed(1) + 'æ—¥' : '-';
      document.getElementById('lowRemainingCount').textContent =
        (stats.lowRemainingCount || 0) + 'å';
      document.getElementById('totalRemainingDays').textContent =
        (stats.totalRemainingDays || 0) + 'æ—¥';

      // äº‹æ¥­æ‰€åˆ¥çµ±è¨ˆã®è¡¨ç¤º
      if (stats.divisionCounts) {
        var tbody = document.getElementById('divisionStatistics');
        var html = '';

        var divisions = {
          'R': 'ãƒ©ã‚¤ã‚º',
          'P': 'ãƒ‘ãƒ­ãƒ³',
          'S': 'ã‚·ã‚¨ãƒ«',
          'E': 'EBISU'
        };

        Object.keys(divisions).forEach(function(code) {
          var count = stats.divisionCounts[code] || 0;
          var avgDays = stats.divisionAverages && stats.divisionAverages[code]
            ? stats.divisionAverages[code].toFixed(1)
            : '-';
          var totalDays = stats.divisionTotals && stats.divisionTotals[code]
            ? stats.divisionTotals[code]
            : '-';

          html += '<tr style="border-bottom: 1px solid #ddd;">';
          html += '<td style="padding: 12px;">' + divisions[code] + '</td>';
          html += '<td style="padding: 12px; text-align: right;">' + count + 'å</td>';
          html += '<td style="padding: 12px; text-align: right;">' + avgDays + (avgDays !== '-' ? 'æ—¥' : '') + '</td>';
          html += '<td style="padding: 12px; text-align: right;">' + totalDays + (totalDays !== '-' ? 'æ—¥' : '') + '</td>';
          html += '</tr>';
        });

        tbody.innerHTML = html;
      }
    }
  </script>
</body>
</html>