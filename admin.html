

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <style>
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #employeeTable {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #employeeTable th {
      background-color: #4CAF50;
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: bold;
      border: 1px solid #4CAF50;
      position: sticky;
      top: 0;
    }
    
    #employeeTable td {
      padding: 10px 8px;
      border: 1px solid #ddd;
    }
    
    #employeeTable tbody tr:hover {
      background-color: #f5f5f5;
    }
    
    #employeeTable tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    /* æ®‹æ—¥æ•°ã®å¼·èª¿è¡¨ç¤º */
    .remaining-days {
      font-weight: bold;
      font-size: 16px;
    }
    
    .remaining-low {
      color: #ff9800;
    }
    
    .remaining-critical {
      color: #f44336;
    }
    
    /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #employeeTable button {
      padding: 6px 12px;
      margin: 0 2px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      background-color: #2196F3;
      color: white;
    }
    
    #employeeTable button:hover {
      background-color: #1976D2;
    }
    
    #employeeTable button.remarks-btn {
      background-color: #FF9800;
    }
    
    #employeeTable button.remarks-btn:hover {
      background-color: #F57C00;
    }
    
    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éƒ¨åˆ†ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .controls {
      margin: 20px 0;
      padding: 15px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .controls input {
      padding: 10px;
      width: 300px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 14px;
    }
    
    .controls input:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .controls select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 14px;
    }
    
    /* çµ±è¨ˆæƒ…å ± */
    .stats {
      margin: 20px 0;
      padding: 15px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 30px;
    }
    
    .stat-item {
      flex: 1;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .stat-label {
      color: #666;
      font-size: 14px;
    }
    
    /* è¡Œç•ªå·åˆ—ã‚’éè¡¨ç¤º */
    #employeeTable th:first-child,
    #employeeTable td:first-child {
      display: none;
    }
    
    /* å‚™è€ƒæ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .remarks-cell {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .remarks-cell:hover {
      white-space: normal;
      overflow: visible;
    }
    
    /* ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
    .tabs {
      margin: 20px 0;
      border-bottom: 2px solid #4CAF50;
    }
    
    .tab-button {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-bottom: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;
    }
    
    .tab-button.active {
      background-color: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    
    .tab-content {
      display: none;
      margin-top: 20px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ç”³è«‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    #applicationTable {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #applicationTable th {
      background-color: #4CAF50;
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: bold;
      border: 1px solid #4CAF50;
    }
    
    #applicationTable td {
      padding: 10px 8px;
      border: 1px solid #ddd;
    }
    
    #applicationTable tbody tr:hover {
      background-color: #f5f5f5;
    }
    
    .approve-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 5px;
    }
    
    .approve-btn:hover {
      background-color: #45a049;
    }
    
    .reject-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .reject-btn:hover {
      background-color: #da190b;
    }
    
    .status-pending {
      color: #ff9800;
      font-weight: bold;
    }
    
    .status-approved {
      color: #4CAF50;
      font-weight: bold;
    }
  </style>
  <title>åˆ©ç”¨è€…ä¸€è¦§</title>
</head>
<body>
  <h1>ç®¡ç†ç”»é¢</h1>
  
  <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
  <div class="tabs">
    <button class="tab-button active" onclick="showTab('employees')">åˆ©ç”¨è€…ä¸€è¦§</button>
    <button class="tab-button" onclick="showTab('applications')">ç”³è«‹æ‰¿èª</button>
    <button class="tab-button" onclick="showTab('url-management')">URLç®¡ç†</button>
  </div>
  
  <!-- åˆ©ç”¨è€…ä¸€è¦§ã‚¿ãƒ– -->
  <div id="employeesTab" class="tab-content active">
    <h2>åˆ©ç”¨è€…ä¸€è¦§</h2>
    <div class="stats" id="statsContainer">
    <div class="stat-item">
      <div class="stat-value" id="totalCount">-</div>
      <div class="stat-label">ç™»éŒ²è€…æ•°</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="avgRemaining">-</div>
      <div class="stat-label">å¹³å‡æ®‹æ—¥æ•°</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="zeroCount">-</div>
      <div class="stat-label">æ®‹æ—¥æ•°ã‚¼ãƒ­</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="lowCount">-</div>
      <div class="stat-label">æ®‹æ—¥æ•°5æ—¥ä»¥ä¸‹</div>
    </div>
  </div>
  
  <div class="controls">
    <input type="text" id="searchInput" placeholder="åˆ©ç”¨è€…ç•ªå·ã€æ°åã€å‚™è€ƒã§æ¤œç´¢...">
    <select id="remainingFilter">
      <option value="">æ®‹æ—¥æ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</option>
      <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
      <option value="low">5æ—¥ä»¥ä¸‹ã®ã¿</option>
      <option value="zero">ã‚¼ãƒ­ã®ã¿</option>
    </select>
    <select id="sortBy">
      <option value="">ä¸¦ã³æ›¿ãˆ</option>
      <option value="remaining">æ®‹æ—¥æ•°é †</option>
      <option value="userName">æ°åé †</option>
    </select>
  </div>
  
  <table id="employeeTable">
    <thead>
      <tr>
        <th>è¡Œç•ªå·</th>
        <th>åˆ©ç”¨è€…ç•ªå·</th>
        <th>æ°å</th>
        <th>æœ‰çµ¦æ®‹æ—¥æ•°</th>
        <th>å‚™è€ƒ</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
  
  <!-- ç”³è«‹æ‰¿èªã‚¿ãƒ– -->
  <div id="applicationsTab" class="tab-content">
    <h2>ç”³è«‹æ‰¿èª</h2>
    
    <div class="controls">
      <input type="text" id="applicationSearch" placeholder="åˆ©ç”¨è€…åã§æ¤œç´¢...">
    </div>
    
    <table id="applicationTable">
      <thead>
        <tr>
          <th>åˆ©ç”¨è€…ç•ªå·</th>
          <th>åˆ©ç”¨è€…å</th>
          <th>ç”³è«‹æ—¥</th>
          <th>æ—¥æ•°</th>
          <th>ç”³è«‹æ—¥æ™‚</th>
          <th>çŠ¶æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var allEmployees = [];
    var allApplications = [];
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    function showTab(tabName) {
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
      var tabButtons = document.querySelectorAll('.tab-button');
      var tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(function(button) {
        button.classList.remove('active');
      });
      
      tabContents.forEach(function(content) {
        content.classList.remove('active');
      });
      
      // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
      if (tabName === 'employees') {
        document.querySelector('button[onclick="showTab(\'employees\')"]').classList.add('active');
        document.getElementById('employeesTab').classList.add('active');
      } else if (tabName === 'applications') {
        document.querySelector('button[onclick="showTab(\'applications\')"]').classList.add('active');
        document.getElementById('applicationsTab').classList.add('active');
        loadApplications(); // ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
      }
    }
    
    // åˆæœŸåŒ–é–¢æ•°
    function onLoad() {
      console.log('ğŸ”§ ç®¡ç†ç”»é¢ - åˆæœŸåŒ–é–‹å§‹');
      
      var searchInput = document.getElementById('searchInput');
      var remainingFilter = document.getElementById('remainingFilter');
      var sortBy = document.getElementById('sortBy');
      var applicationSearch = document.getElementById('applicationSearch');
      
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          console.log('ğŸ” æ¤œç´¢å…¥åŠ›å¤‰æ›´:', searchInput.value);
          loadEmployees();
        });
      }
      
      if (remainingFilter) {
        remainingFilter.addEventListener('change', function() {
          console.log('ğŸ¯ æ®‹æ—¥æ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´:', remainingFilter.value);
          loadEmployees();
        });
      }
      
      if (sortBy) {
        sortBy.addEventListener('change', function() {
          console.log('ğŸ”„ ä¸¦ã³æ›¿ãˆå¤‰æ›´:', sortBy.value);
          loadEmployees();
        });
      }
      
      if (applicationSearch) {
        applicationSearch.addEventListener('input', function() {
          console.log('ğŸ” ç”³è«‹æ¤œç´¢å…¥åŠ›å¤‰æ›´:', applicationSearch.value);
          displayApplications();
        });
      }
      
      console.log('ğŸ“Š åˆå›ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰é–‹å§‹...');
      loadEmployees();
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œ
    window.onload = onLoad;
    
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
    function loadEmployees() {
      console.log('ğŸ“Š åˆ©ç”¨è€…ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...');
      
      var searchInput = document.getElementById('searchInput');
      var remainingFilter = document.getElementById('remainingFilter');
      var sortBy = document.getElementById('sortBy');
      
      var filter = searchInput ? String(searchInput.value || '') : '';
      var remainingFilterValue = remainingFilter ? remainingFilter.value : '';
      var sortByValue = sortBy ? sortBy.value : '';
      
      console.log('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶:', { 
        filter: filter, 
        remainingFilter: remainingFilterValue,
        sortBy: sortByValue
      });
      
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
          console.log('ğŸ“Š å–å¾—ä»¶æ•°:', data && data.records ? data.records.length : 0);
          
          if (data && data.records) {
            allEmployees = data.records;
            renderTable(allEmployees);
            updateStats(data);
            console.log('ğŸ¯ è¡¨ç¤ºå®Œäº†');
          } else {
            console.warn('âš ï¸ ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯recordsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            allEmployees = [];
            renderTable([]);
            updateStats({ stats: { total: 0, zeroCount: 0, lowCount: 0 } });
          }
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          allEmployees = [];
          renderTable([]);
          updateStats({ stats: { total: 0, zeroCount: 0, lowCount: 0 } });
        })
        .getEmployees({ 
          filter: filter,
          remainingFilter: remainingFilterValue,
          sortBy: sortByValue
        });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–¢æ•°
    function renderTable(employees) {
      console.log('ğŸ¨ ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–‹å§‹ - ä»¶æ•°:', employees.length);
      
      var tbody = document.querySelector('#employeeTable tbody');
      if (!tbody) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ã®tbodyè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      tbody.innerHTML = '';
      
      if (!employees || employees.length === 0) {
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.colSpan = 5;  // å‚™è€ƒåˆ—ã‚’å«ã‚ã¦5åˆ—
        td.style.textAlign = 'center';
        td.style.color = '#666';
        td.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
        tr.appendChild(td);
        tbody.appendChild(tr);
        console.log('ğŸ“‹ ç©ºã®ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º');
        return;
      }
      
      employees.forEach(function(emp) {
        console.log('ğŸ“ è¡Œãƒ‡ãƒ¼ã‚¿:', emp);
        
        var tr = document.createElement('tr');
        
        // è¡Œç•ªå·ï¼ˆéè¡¨ç¤ºï¼‰
        var tdRowNum = document.createElement('td');
        tdRowNum.textContent = emp.rowNumber;
        tr.appendChild(tdRowNum);
        
        // åˆ©ç”¨è€…ç•ªå·
        var tdUserId = document.createElement('td');
        tdUserId.textContent = emp.userId;
        tr.appendChild(tdUserId);
        
        // æ°å
        var tdUserName = document.createElement('td');
        tdUserName.textContent = emp.userName;
        tr.appendChild(tdUserName);
        
        // æœ‰çµ¦æ®‹æ—¥æ•°
        var tdRemaining = document.createElement('td');
        var remainingSpan = document.createElement('span');
        remainingSpan.className = 'remaining-days';
        remainingSpan.textContent = emp.remaining + ' æ—¥';
        
        // æ®‹æ—¥æ•°ã«ã‚ˆã‚‹è‰²åˆ†ã‘
        if (emp.remaining <= 3) {
          remainingSpan.className += ' remaining-critical';
        } else if (emp.remaining <= 5) {
          remainingSpan.className += ' remaining-low';
        }
        
        tdRemaining.appendChild(remainingSpan);
        tr.appendChild(tdRemaining);
        
        // å‚™è€ƒ
        var tdRemarks = document.createElement('td');
        tdRemarks.className = 'remarks-cell';
        tdRemarks.textContent = emp.remarks || '';
        tdRemarks.title = emp.remarks || ''; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§å…¨æ–‡è¡¨ç¤º
        tr.appendChild(tdRemarks);
        
        // æ“ä½œãƒœã‚¿ãƒ³
        var tdActions = document.createElement('td');
        
        // æ®‹æ—¥æ•°ç·¨é›†ãƒœã‚¿ãƒ³
        var editBtn = document.createElement('button');
        editBtn.textContent = 'æ®‹æ—¥æ•°';
        editBtn.onclick = function() {
          editRemaining(emp.rowNumber, emp.userId, emp.userName, emp.remaining);
        };
        tdActions.appendChild(editBtn);
        
        // å‚™è€ƒç·¨é›†ãƒœã‚¿ãƒ³
        var remarksBtn = document.createElement('button');
        remarksBtn.textContent = 'å‚™è€ƒ';
        remarksBtn.className = 'remarks-btn';
        remarksBtn.onclick = function() {
          editRemarks(emp.rowNumber, emp.userId, emp.userName, emp.remarks);
        };
        tdActions.appendChild(remarksBtn);
        
        tr.appendChild(tdActions);
        
        tbody.appendChild(tr);
      });
      
      console.log('ğŸ¯ ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å®Œäº†');
    }
    
    // çµ±è¨ˆæƒ…å ±æ›´æ–°
    function updateStats(data) {
      if (data.stats) {
        document.getElementById('totalCount').textContent = data.stats.total || 0;
        document.getElementById('zeroCount').textContent = data.stats.zeroCount || 0;
        document.getElementById('lowCount').textContent = data.stats.lowCount || 0;
      }
      
      // å¹³å‡æ®‹æ—¥æ•°ã®è¨ˆç®—
      var employees = data.records || [];
      var totalRemaining = employees.reduce(function(sum, emp) {
        return sum + (parseFloat(emp.remaining) || 0);
      }, 0);
      var avgRemaining = employees.length > 0 ? (totalRemaining / employees.length).toFixed(1) : 0;
      document.getElementById('avgRemaining').textContent = avgRemaining + ' æ—¥';
    }
    
    // æ®‹æ—¥æ•°ç·¨é›†
    function editRemaining(rowNumber, userId, userName, currentRemaining) {
      console.log('âœï¸ æ®‹æ—¥æ•°ç·¨é›†é–‹å§‹ - è¡Œç•ªå·:', rowNumber, 'åˆ©ç”¨è€…:', userName);
      
      var newValue = prompt(
        'ã€' + userName + ' ã•ã‚“ã€‘\n' +
        'ç¾åœ¨ã®æœ‰çµ¦æ®‹æ—¥æ•°: ' + currentRemaining + ' æ—¥\n\n' +
        'æ–°ã—ã„æ®‹æ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',
        currentRemaining
      );
      
      if (newValue === null) {
        console.log('âŒ ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
        return;
      }
      
      var newRemaining = parseFloat(newValue);
      
      if (isNaN(newRemaining)) {
        alert('æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (newRemaining < 0) {
        alert('0ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      console.log('ğŸ“ æ–°ã—ã„æ®‹æ—¥æ•°:', newRemaining);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… æ›´æ–°æˆåŠŸ:', result);
          alert(userName + ' ã•ã‚“ã®æ®‹æ—¥æ•°ã‚’ ' + newRemaining + ' æ—¥ã«æ›´æ–°ã—ã¾ã—ãŸ');
          loadEmployees();
        })
        .withFailureHandler(function(error) {
          console.error('âŒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .updateEmployeeRemaining({
          rowNumber: rowNumber,
          newRemaining: newRemaining
        });
    }
    
    // å‚™è€ƒç·¨é›†
    function editRemarks(rowNumber, userId, userName, currentRemarks) {
      console.log('âœï¸ å‚™è€ƒç·¨é›†é–‹å§‹ - è¡Œç•ªå·:', rowNumber, 'åˆ©ç”¨è€…:', userName);
      
      var newValue = prompt(
        'ã€' + userName + ' ã•ã‚“ã€‘\n' +
        'ç¾åœ¨ã®å‚™è€ƒ: ' + (currentRemarks || 'ï¼ˆãªã—ï¼‰') + '\n\n' +
        'æ–°ã—ã„å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',
        currentRemarks || ''
      );
      
      if (newValue === null) {
        console.log('âŒ ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
        return;
      }
      
      console.log('ğŸ“ æ–°ã—ã„å‚™è€ƒ:', newValue);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… å‚™è€ƒæ›´æ–°æˆåŠŸ:', result);
          alert(userName + ' ã•ã‚“ã®å‚™è€ƒã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          loadEmployees();
        })
        .withFailureHandler(function(error) {
          console.error('âŒ å‚™è€ƒæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          alert('å‚™è€ƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .updateEmployeeRemarks({
          rowNumber: rowNumber,
          newRemarks: newValue
        });
    }
    
    // ç”³è«‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadApplications() {
      console.log('ğŸ“Š ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', result);
          // getApplicationsã¯{records: [], pagination: {}}å½¢å¼ã§è¿”ã™ã®ã§ã€recordsã‚’å–å¾—
          allApplications = (result && result.records) ? result.records : [];
          displayApplications();
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ç”³è«‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          alert('ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getApplications({});
    }
    
    // ç”³è«‹ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
    function displayApplications() {
      var tbody = document.querySelector('#applicationTable tbody');
      if (!tbody) return;
      
      var searchText = document.getElementById('applicationSearch').value.toLowerCase();
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆæ‰¿èªå¾…ã¡ã®ã¿è¡¨ç¤ºï¼‰
      var filteredApplications = allApplications.filter(function(app) {
        var matchesSearch = !searchText || app.userName.toLowerCase().includes(searchText);
        // æ‰¿èªå¾…ã¡ï¼ˆPendingï¼‰ã®ã¿è¡¨ç¤º
        return matchesSearch && app.status === 'Pending';
      });
      
      if (filteredApplications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666; padding: 20px;">è©²å½“ã™ã‚‹ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }
      
      var html = '';
      filteredApplications.forEach(function(app) {
        var daysText = (app.applyDays === 0.5) ? '0.5æ—¥' : '1æ—¥';
        html += '<tr>';
        html += '<td>' + app.userId + '</td>';
        html += '<td>' + app.userName + '</td>';
        html += '<td>' + app.applyDate + '</td>';
        html += '<td>' + daysText + '</td>';
        html += '<td>' + app.timestamp + '</td>';
        html += '<td class="status-' + app.status.toLowerCase() + '">';
        html += app.status === 'Pending' ? 'æ‰¿èªå¾…ã¡' : app.status === 'Approved' ? 'æ‰¿èªæ¸ˆã¿' : app.status;
        html += '</td>';
        html += '<td>';
        
        if (app.status === 'Pending') {
          html += '<button class="approve-btn" onclick="approveApplication(' + app.recordId + ', \'' + app.userName + '\')">æ‰¿èª</button>';
          html += '<button class="reject-btn" onclick="rejectApplication(' + app.recordId + ', \'' + app.userName + '\')">å´ä¸‹</button>';
        } else {
          html += '<span style="color: #999;">-</span>';
        }
        
        html += '</td>';
        html += '</tr>';
      });
      
      tbody.innerHTML = html;
    }
    
    // ç”³è«‹æ‰¿èª
    function approveApplication(rowNumber, userName) {
      if (!confirm(userName + ' ã•ã‚“ã®ç”³è«‹ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      console.log('âœ… ç”³è«‹æ‰¿èªé–‹å§‹:', rowNumber, userName);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… ç”³è«‹æ‰¿èªæˆåŠŸ:', result);
          alert(userName + ' ã•ã‚“ã®ç”³è«‹ã‚’æ‰¿èªã—ã¾ã—ãŸ');
          // æ‰¿èªå¾Œã¯ç”³è«‹æ‰¿èªã‚¿ãƒ–ã‚’å†è¡¨ç¤º
          refreshApplicationTab();
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ç”³è«‹æ‰¿èªã‚¨ãƒ©ãƒ¼:', error);
          if (error.message && error.message.includes('æ—¢ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™')) {
            alert('ã“ã®ç”³è«‹ã¯æ—¢ã«ä»–ã®ç®¡ç†è€…ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚\nç”»é¢ã‚’æ›´æ–°ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
            refreshApplicationTab();
          } else {
            alert('ç”³è«‹ã®æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
        })
        .approveRecord({
          rowNumber: rowNumber,
          status: 'Approved'
        });
    }
    
    // ç”³è«‹å´ä¸‹
    function rejectApplication(rowNumber, userName) {
      if (!confirm(userName + ' ã•ã‚“ã®ç”³è«‹ã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      console.log('âŒ ç”³è«‹å´ä¸‹é–‹å§‹:', rowNumber, userName);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('âœ… ç”³è«‹å´ä¸‹æˆåŠŸ:', result);
          alert(userName + ' ã•ã‚“ã®ç”³è«‹ã‚’å´ä¸‹ã—ã¾ã—ãŸ');
          // å´ä¸‹å¾Œã¯ç”³è«‹æ‰¿èªã‚¿ãƒ–ã‚’å†è¡¨ç¤º
          refreshApplicationTab();
        })
        .withFailureHandler(function(error) {
          console.error('âŒ ç”³è«‹å´ä¸‹ã‚¨ãƒ©ãƒ¼:', error);
          if (error.message && error.message.includes('æ—¢ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™')) {
            alert('ã“ã®ç”³è«‹ã¯æ—¢ã«ä»–ã®ç®¡ç†è€…ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚\nç”»é¢ã‚’æ›´æ–°ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
            refreshApplicationTab();
          } else {
            alert('ç”³è«‹ã®å´ä¸‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
        })
        .approveRecord({
          rowNumber: rowNumber,
          status: 'Rejected'
        });
    }
    
    // ç”³è«‹æ‰¿èªã‚¿ãƒ–ã‚’å†è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function refreshApplicationTab() {
      // ç”³è«‹æ‰¿èªã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
      showTab('applications');
      // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
      loadApplications();
    }
  </script>
  
  <!-- URLç®¡ç†ã‚¿ãƒ– -->
  <div id="url-managementTab" class="tab-content">
    <h2>URLç®¡ç†</h2>
    
    <div class="controls">
      <div style="flex: 1;">
        <h3>å€‹äººURLç®¡ç†</h3>
        <p>åˆ©ç”¨è€…ã”ã¨ã®å°‚ç”¨ã‚¢ã‚¯ã‚»ã‚¹URLã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
      </div>
      <div>
        <button onclick="generateAllUrls()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">
          å…¨å“¡ã®URLç”Ÿæˆ
        </button>
        <button onclick="refreshUrlList()" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px;">
          ä¸€è¦§ã‚’æ›´æ–°
        </button>
      </div>
    </div>
    
    <div id="urlGenerationStatus" style="margin: 20px 0; padding: 15px; border-radius: 5px; display: none;"></div>
    
    <table id="urlTable" style="display: none;">
      <thead>
        <tr>
          <th>åˆ©ç”¨è€…ç•ªå·</th>
          <th>åˆ©ç”¨è€…å</th>
          <th>URLã‚­ãƒ¼</th>
          <th>å°‚ç”¨URL</th>
          <th>ä½œæˆæ—¥</th>
          <th>æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹</th>
          <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="urlTableBody">
      </tbody>
    </table>
    
    <div id="urlTableEmpty" style="text-align: center; color: #666; margin-top: 40px;">
      URLã‚­ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œå…¨å“¡ã®URLç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
    </div>
  </div>

  <script>
    // URLç®¡ç†æ©Ÿèƒ½ã®JavaScript
    
    function generateAllUrls() {
      var statusDiv = document.getElementById('urlGenerationStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '<strong>å‡¦ç†ä¸­...</strong> å…¨åˆ©ç”¨è€…ã®URLã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('URLç”Ÿæˆçµæœ:', result);
          
          if (result.success) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '<strong>å®Œäº†!</strong> ' + result.message;
            
            // çµæœã‚’è¡¨ç¤º
            displayUrlResults(result.results);
            refreshUrlList();
          } else {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.border = '1px solid #f5c6cb';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + result.message;
          }
        })
        .withFailureHandler(function(error) {
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.border = '1px solid #f5c6cb';
          statusDiv.style.color = '#721c24';
          statusDiv.innerHTML = '<strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
        })
        .generateAllUserUrls();
    }
    
    function refreshUrlList() {
      // URLä¸€è¦§ã‚’å–å¾—ã™ã‚‹æ©Ÿèƒ½ï¼ˆå®Ÿè£…ãŒå¿…è¦ï¼‰
      console.log('URLä¸€è¦§ã®æ›´æ–°');
      // ã“ã®æ©Ÿèƒ½ã¯æ¬¡ã®å®Ÿè£…ã§è¿½åŠ äºˆå®š
    }
    
    function displayUrlResults(results) {
      var table = document.getElementById('urlTable');
      var tbody = document.getElementById('urlTableBody');
      var emptyDiv = document.getElementById('urlTableEmpty');
      
      if (results && results.length > 0) {
        tbody.innerHTML = '';
        
        results.forEach(function(item) {
          var row = tbody.insertRow();
          
          if (item.success) {
            var truncatedKey = item.urlKey.substring(0, 8) + '...';
            var shortUrl = item.url.substring(0, 50) + '...';
            
            row.innerHTML = `
              <td>${item.userId}</td>
              <td>${item.userName}</td>
              <td title="${item.urlKey}">${truncatedKey}</td>
              <td>
                <a href="${item.url}" target="_blank" title="${item.url}">${shortUrl}</a>
              </td>
              <td>æ–°è¦ä½œæˆ</td>
              <td>-</td>
              <td style="color: #4CAF50; font-weight: bold;">active</td>
              <td>
                <button onclick="copyUrl('${item.url}')" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 5px;">
                  URLã‚³ãƒ”ãƒ¼
                </button>
                <button onclick="deactivateUrl('${item.userId}')" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px;">
                  ç„¡åŠ¹åŒ–
                </button>
              </td>
            `;
          } else {
            row.innerHTML = `
              <td>${item.userId}</td>
              <td>${item.userName}</td>
              <td colspan="4" style="color: #f44336;">ã‚¨ãƒ©ãƒ¼: ${item.error}</td>
              <td style="color: #f44336;">failed</td>
              <td>-</td>
            `;
          }
        });
        
        table.style.display = 'table';
        emptyDiv.style.display = 'none';
      } else {
        table.style.display = 'none';
        emptyDiv.style.display = 'block';
      }
    }
    
    function copyUrl(url) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(function() {
          alert('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }).catch(function(err) {
          console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
          fallbackCopyUrl(url);
        });
      } else {
        fallbackCopyUrl(url);
      }
    }
    
    function fallbackCopyUrl(url) {
      var textArea = document.createElement("textarea");
      textArea.value = url;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      textArea.style.top = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        alert('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      } catch (err) {
        prompt('ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url);
      }
      
      document.body.removeChild(textArea);
    }
    
    function deactivateUrl(userId) {
      if (!confirm('åˆ©ç”¨è€… ' + userId + ' ã®URLã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ\nç„¡åŠ¹åŒ–å¾Œã¯è©²å½“URLã§ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚')) {
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result) {
            alert('URLã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ');
            refreshUrlList();
          } else {
            alert('URLã‚­ãƒ¼ã®ç„¡åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          alert('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .deactivateUserUrl(userId);
    }
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’æ‹¡å¼µ
    function showTab(tabName) {
      // æ—¢å­˜ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
      var tabs = document.querySelectorAll('.tab-content');
      var buttons = document.querySelectorAll('.tab-button');
      
      tabs.forEach(function(tab) {
        tab.classList.remove('active');
      });
      
      buttons.forEach(function(button) {
        button.classList.remove('active');
      });
      
      var targetTab = document.getElementById(tabName + 'Tab');
      if (targetTab) {
        targetTab.classList.add('active');
      }
      
      event.target.classList.add('active');
      
      // URLç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®åˆæœŸåŒ–
      if (tabName === 'url-management') {
        console.log('URLç®¡ç†ã‚¿ãƒ–ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        // å¿…è¦ã«å¿œã˜ã¦åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
      }
    }
  </script>
</body>
</html>